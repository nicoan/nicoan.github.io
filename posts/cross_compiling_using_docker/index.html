<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Cross compiling Rust using Docker | Nico Antinori</title>
<meta name=keywords content="rust,cross-compiling"><meta name=description content="A while ago, I published an app that I originally made for myself but thought it would be useful for others: Kindly RSS Reader. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.
The only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in Docker Hub. In the future, I plan to create a .deb package and other formats to make deployment more flexible."><meta name=author content="Nicolás Antinori"><link rel=canonical href=https://nicoan.net/posts/cross_compiling_using_docker/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://nicoan.net/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nicoan.net/assets/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://nicoan.net/assets/favicon-32x32.png><link rel=apple-touch-icon href=https://nicoan.net/assets/apple-touch-icon.png><link rel=mask-icon href=https://nicoan.net/assets/apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Cross compiling Rust using Docker"><meta property="og:description" content="A while ago, I published an app that I originally made for myself but thought it would be useful for others: Kindly RSS Reader. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.
The only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in Docker Hub. In the future, I plan to create a .deb package and other formats to make deployment more flexible."><meta property="og:type" content="article"><meta property="og:url" content="https://nicoan.net/posts/cross_compiling_using_docker/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-06T12:00:00-03:00"><meta property="article:modified_time" content="2025-03-06T12:00:00-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cross compiling Rust using Docker"><meta name=twitter:description content="A while ago, I published an app that I originally made for myself but thought it would be useful for others: Kindly RSS Reader. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.
The only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in Docker Hub. In the future, I plan to create a .deb package and other formats to make deployment more flexible."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nicoan.net/posts/"},{"@type":"ListItem","position":2,"name":"Cross compiling Rust using Docker","item":"https://nicoan.net/posts/cross_compiling_using_docker/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Cross compiling Rust using Docker","name":"Cross compiling Rust using Docker","description":"A while ago, I published an app that I originally made for myself but thought it would be useful for others: Kindly RSS Reader. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.\nThe only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in Docker Hub. In the future, I plan to create a .deb package and other formats to make deployment more flexible.\n","keywords":["rust","cross-compiling"],"articleBody":"A while ago, I published an app that I originally made for myself but thought it would be useful for others: Kindly RSS Reader. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.\nThe only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in Docker Hub. In the future, I plan to create a .deb package and other formats to make deployment more flexible.\nIssues requesting support for other architectures I was pleasantly surprised by the attention the project received. After a week of publishing the repository I got received two issues asking to support older arm architectures and for x86_64.\nSupporting more architectures was something I had in mind from the beginning of the project. There are a lot of single-board and low end computers out there that could run the project, so I was happy to see people interested in running it on different architectures.\nThe approach At the moment I got two computers: A MacBook running an ARMv8 and an old desktop running x86_64. I wanted the build process to be as portable as possible, so I could use either machine, and I usually do not like to install things in the OS unless is absolutely necessary. Using docker for building met both my requirements.\nThe final images I wanted the final images to be as lightweight as possible. That’s why I opted for Alpine Linux docker images. Alpine Linux is a small1 linux distribution focused on security.\nOne thing that differentiates Alpine from other distributions is that it uses musl C library instad of GNU C Library. This is an important detail for cross-compilation.\nThe linkers image To be able to cross compile projects, we need to use different linkers: one for each target architecture. The target architectures are armv6, armv7, arm64v8 (or aarch64) and x86_64.\nThe first step was to create a Docker image containing all the necessary linkers. To download and install the them I used the musl-cross-make project.\n# This image will be used for building the project in different platforms FROM rust:1.84-bullseye AS builder WORKDIR /home RUN git clone https://github.com/richfelker/musl-cross-make.git --depth 1 # armv6 RUN cd musl-cross-make \\ \u0026\u0026 echo 'TARGET = arm-linux-musleabihf' \u003e config.mak \\ \u0026\u0026 echo 'OUTPUT = /build/cross-armv6' \u003e\u003e config.mak \\ \u0026\u0026 make \\ \u0026\u0026 make install # armv7 RUN cd musl-cross-make \\ \u0026\u0026 echo 'TARGET = armv7-linux-musleabihf' \u003e config.mak \\ \u0026\u0026 echo 'OUTPUT = /build/cross-armv7' \u003e\u003e config.mak \\ \u0026\u0026 make \\ \u0026\u0026 make install # arm64v8 RUN cd musl-cross-make \\ \u0026\u0026 echo 'TARGET = aarch64-linux-musl' \u003e config.mak \\ \u0026\u0026 echo 'OUTPUT = /build/cross-armv8' \u003e\u003e config.mak \\ \u0026\u0026 make \\ \u0026\u0026 make install # x86_64 RUN cd musl-cross-make \\ \u0026\u0026 echo 'TARGET = x86_64-linux-musl' \u003e config.mak \\ \u0026\u0026 echo 'OUTPUT = /build/cross-x86_64' \u003e\u003e config.mak \\ \u0026\u0026 make \\ \u0026\u0026 make install ENTRYPOINT [\"/bin/bash\"] As base image, I used rust:1.84-bullseye because it includes all the tools I need for building the project (with the exception of the additional targets, which will be installed manually in the respective Dockerfile).\nThe command used for building this image is:\ndocker build \\ --tag nicoan/kindly-rss-builder \\ -f ./dockerfiles/Dockerfile.build \\ . Building the images To build the project, I use four different Dockerfiles: One for each architecture. I could have created one Dockerfile with parameters but I wanted to take advantage of the Docker’s layer caching mechanism. Here’s the Dockerfile for the armv6 architecture:\nFROM --platform=$BUILDPLATFORM nicoan/kindly-rss-builder AS builder WORKDIR /home ENV PATH=$PATH:/build/cross-armv6/bin ENV CARGO_TARGET_ARM_UNKNOWN_LINUX_MUSLEABIHF_LINKER=arm-linux-musleabihf-gcc RUN rustup target add arm-unknown-linux-musleabihf COPY . ./ RUN cargo build --target arm-unknown-linux-musleabihf --release FROM alpine:3 AS run RUN mkdir -p /home/kindlyrss/static_data \\ \u0026\u0026 mkdir -p /home/kindlyrss/data EXPOSE 3000/tcp COPY --from=builder /home/target/arm-unknown-linux-musleabihf/release/kindle-rss-reader /usr/local/bin/kindlyrss COPY --from=builder /home/templates/ /home/kindlyrss/static_data/templates/ COPY --from=builder /home/migrations/ /home/kindlyrss/static_data/migrations/ COPY --from=builder /home/static/ /home/kindlyrss/static_data/static/ COPY --from=builder /home/config/config.json /home/kindlyrss/data/config.json ENV RUST_LOG=info ENV MAX_ARTICLES_QTY_TO_DOWNLOAD=0 ENV STATIC_DATA_PATH=/home/kindlyrss/static_data ENV DATA_PATH=/home/kindlyrss/data CMD [\"kindlyrss\"] The idea is to use a multi-stage build with two stages: build and run.\nIn the build stage:\nLine 1: We use the linkers image with the --platform=$BUILDPLATFORM parameter to ensure that no emulation will be used in this stage. Line 5: We add to the $PATH environment variable the path where the linker’s binaries are located. Line 6: We tell cargo which linker we are going to use for compiling armv6. This can be done through environment variables or with a configuration file. The shape of the environment variables specifying the linker is CARGO_TARGET__LINKER. The format of the is ---. The four environment variables used are: CARGO_TARGET_ARM_UNKNOWN_LINUX_MUSLEABIHF_LINKER for armv6 CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABIHF_LINKER for armv7 CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER for arm64v8 CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER for x86_64 Line 8: We add the arm-unknown-linux-musleabihf target to be able to build the project for the armv6 architecture using the musl C library. The four targets used are: arm-unknown-linux-musleabihf for armv6 armv7-unknown-linux-musleabihf for armv7 aarch64-unknown-linux-musl for arm64v8 x86_64-unknown-linux-musl for x86_64 Line 9: We copy the source. Line 11: We build the project in release mode targeting the armv6 architecture. The run stage will be built using alpine as base. This stage is the last one and will output the final image for armv6. Here, we copy the binary file and all the files needed by it to run the application correctly from the builder stage, expose the port 3000 and set some configurations using environment variables. After that we execute the binary to run the application.\nNote that in the Dockerfile is never specified the platform to be used. This is done using the --platform argument in the docker build command.\nThe command used to build this image is:\ndocker build \\ --tag nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv6 \\ --platform linux/arm/v6 \\ -f ./dockerfiles/Dockerfile.armv6 \\ . where $(PACKAGE_VERSION) is the app version.\nPublishing the images To publish the images we just need a Docker Hub account and use the docker push command. Since we are supporting more than one architecture, it would be nice to have all the images targeting different platforms grouped in the same tag. This can be achieved by pushing all the different images separately and then creating a manifest pointing at them under the same tag.\nFor example, for version 0.1.0, we first push the four images:\ndocker push nicoan/kindly-rss-reader:0.1.0-armx86_64 docker push nicoan/kindly-rss-reader:0.1.0-arm64v8 docker push nicoan/kindly-rss-reader:0.1.0-armv7 docker push nicoan/kindly-rss-reader:0.1.0-armv6 After that we create a manifest file for the tag 0.1.0 attaching all the images that we just pushed to the hub:\ndocker manifest create nicoan/kindly-rss-reader:0.1.0 \\ --amend nicoan/kindly-rss-reader:0.1.0-armx86_64 \\ --amend nicoan/kindly-rss-reader:0.1.0-arm64v8 \\ --amend nicoan/kindly-rss-reader:0.1.0-armv7 \\ --amend nicoan/kindly-rss-reader:0.1.0-armv6 And push it:\ndocker manifest push nicoan/kindly-rss-reader:0.1.0 The same thing can be done with the latest tag with an extra step: we first need to delete its manifest and then re-create it with the images we want to group. If we don’t do the delete step, the new images will be grouped with all the previous ones.\nDoing all this process semi-automatically I am not good at remembering all the arguments and details of the commands I use. That’s why I usually try to create scripts to automate the processes. In this case I opted to use a good old Makefile:\n# Extract the version from Cargo.toml PACKAGE_VERSION=$(shell cat Cargo.toml | grep version | head -n 1 | awk '{print $$3}' | sed -e 's/\"//g') # Build for different archs # I opted to use multiple Dockerfiles to take advantage of the layer caching mechanism. docker-build: docker build \\ --tag nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armx86_64 \\ -f ./dockerfiles/Dockerfile.x86_64 \\ --platform linux/amd64 \\ . docker build \\ --tag nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-arm64v8 \\ -f ./dockerfiles/Dockerfile.armv8 \\ --platform linux/arm64/v8 \\ . docker build \\ --tag nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv6 \\ --platform linux/arm/v6 \\ -f ./dockerfiles/Dockerfile.armv6 \\ . docker build \\ --tag nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv7 \\ --platform linux/arm/v7 \\ -f ./dockerfiles/Dockerfile.armv7 \\ . # Builds an image with different linkers to be able to build # for different architectures docker-prepare-build-image: docker build \\ --tag nicoan/kindly-rss-builder \\ -f ./dockerfiles/Dockerfile.build \\ . # Push new versions docker-push: # Push different architecture images docker push nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armx86_64 docker push nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-arm64v8 docker push nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv7 docker push nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv6 # Create manifest for the package version and push docker manifest create nicoan/kindly-rss-reader:$(PACKAGE_VERSION) \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armx86_64 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-arm64v8 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv7 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv6 docker manifest push nicoan/kindly-rss-reader:$(PACKAGE_VERSION) # Create manifest for the latest tag and push docker manifest rm nicoan/kindly-rss-reader:latest docker manifest create nicoan/kindly-rss-reader:latest \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armx86_64 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-arm64v8 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv7 \\ --amend nicoan/kindly-rss-reader:$(PACKAGE_VERSION)-armv6 docker manifest push nicoan/kindly-rss-reader:latest git-tag-and-push: git tag v$(PACKAGE_VERSION) git push origin v$(PACKAGE_VERSION) .PHONY: build-docker docker-push docker-prepare-build-image git-tag-and-push This way, I just have to write in the terminal\nmake docker-prepare-build-image make docker-build make docker-push Conclusion Using Docker to cross-compile Rust projects ensures portability and ease of deployment. This process could be used in some CI/CD pipeline fully automate the process.\nResources https://docs.docker.com/build/building/multi-platform/ https://doc.rust-lang.org/cargo/reference/config.html https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/ Compressed docker images are around 3.5 MBs while Debian stable slim are around 25MBs. ↩︎\n","wordCount":"1481","inLanguage":"en","datePublished":"2025-03-06T12:00:00-03:00","dateModified":"2025-03-06T12:00:00-03:00","author":{"@type":"Person","name":"Nicolás Antinori"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nicoan.net/posts/cross_compiling_using_docker/"},"publisher":{"@type":"Organization","name":"Nico Antinori","logo":{"@type":"ImageObject","url":"https://nicoan.net/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nicoan.net/ accesskey=h title="Nico Antinori (Alt + H)">Nico Antinori</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://nicoan.net/ title=Home><span>Home</span></a></li><li><a href=https://nicoan.net/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://nicoan.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://nicoan.net/series/ title=Series><span>Series</span></a></li><li><a href=https://nicoan.net/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Cross compiling Rust using Docker</h1><div class=post-meta><span title='2025-03-06 12:00:00 -0300 -03'>March 6, 2025</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Nicolás Antinori</div></header><div class=post-content><p>A while ago, I published an app that I originally made for myself but thought it would be useful for others: <a href=https://kindlyrss.app/>Kindly RSS Reader</a>. Kindly RSS Reader is a self-hosted RSS aggregator designed for e-ink devices and optimized for low-end computers such as the Raspberry Pi. In fact, I run it on a Raspberry Pi 3B powered by a USB port.</p><p>The only way to deploy it at the moment is via Docker (or compiling the source and running it by manually). I’ve uploaded the image in <a href=https://hub.docker.com/r/nicoan/kindly-rss-reader/>Docker Hub</a>. In the future, I plan to create a <code>.deb</code> package and other formats to make deployment more flexible.</p><h1 id=issues-requesting-support-for-other-architectures>Issues requesting support for other architectures<a hidden class=anchor aria-hidden=true href=#issues-requesting-support-for-other-architectures>#</a></h1><p>I was pleasantly surprised by the attention the project received. After a week of publishing the repository I got received two issues asking to <a href=https://github.com/nicoan/kindly-rss-reader/issues/5>support older arm architectures</a> and for <a href=https://github.com/nicoan/kindly-rss-reader/issues/7>x86_64</a>.</p><p>Supporting more architectures was something I had in mind from the beginning of the project. There are a lot of single-board and low end computers out there that could run the project, so I was happy to see people interested in running it on different architectures.</p><h1 id=the-approach>The approach<a hidden class=anchor aria-hidden=true href=#the-approach>#</a></h1><p>At the moment I got two computers: A MacBook running an ARMv8 and an old desktop running x86_64. I wanted the build process to be as portable as possible, so I could use either machine, and I usually do not like to install things in the OS unless is absolutely necessary. Using docker for building met both my requirements.</p><h2 id=the-final-images>The final images<a hidden class=anchor aria-hidden=true href=#the-final-images>#</a></h2><p>I wanted the final images to be as lightweight as possible. That’s why I opted for <a href=https://alpinelinux.org/>Alpine Linux</a> <a href=https://hub.docker.com/_/alpine>docker images</a>. Alpine Linux is a small<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> linux distribution focused on security.</p><p>One thing that differentiates Alpine from other distributions is that it uses <a href=https://www.musl-libc.org/>musl C library</a> instad of <a href=https://www.gnu.org/software/libc/>GNU C Library</a>. This is an important detail for cross-compilation.</p><h2 id=the-linkers-image>The linkers image<a hidden class=anchor aria-hidden=true href=#the-linkers-image>#</a></h2><p>To be able to cross compile projects, we need to use different linkers: one for each target architecture. The target architectures are <code>armv6</code>, <code>armv7</code>, <code>arm64v8</code> (or <code>aarch64</code>) and <code>x86_64</code>.</p><p>The first step was to create a Docker image containing all the necessary linkers. To download and install the them I used the <a href=https://github.com/richfelker/musl-cross-make>musl-cross-make</a> project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># This image will be used for building the project in different platforms</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> rust:1.84-bullseye AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /home</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone https://github.com/richfelker/musl-cross-make.git --depth <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># armv6</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd musl-cross-make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;TARGET = arm-linux-musleabihf&#39;</span> &gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;OUTPUT = /build/cross-armv6&#39;</span> &gt;&gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># armv7</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd musl-cross-make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;TARGET = armv7-linux-musleabihf&#39;</span> &gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;OUTPUT = /build/cross-armv7&#39;</span> &gt;&gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># arm64v8</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd musl-cross-make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;TARGET = aarch64-linux-musl&#39;</span> &gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;OUTPUT = /build/cross-armv8&#39;</span> &gt;&gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># x86_64</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd musl-cross-make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;TARGET = x86_64-linux-musl&#39;</span> &gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;OUTPUT = /build/cross-x86_64&#39;</span> &gt;&gt; config.mak <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>As base image, I used <code>rust:1.84-bullseye</code> because it includes all the tools I need for building the project (with the exception of the additional targets, which will be installed manually in the respective Dockerfile).</p><p>The command used for building this image is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tag nicoan/kindly-rss-builder <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f ./dockerfiles/Dockerfile.build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    .
</span></span></code></pre></div><h2 id=building-the-images>Building the images<a hidden class=anchor aria-hidden=true href=#building-the-images>#</a></h2><p>To build the project, I use four different Dockerfiles: One for each architecture. I could have created one Dockerfile with parameters but I wanted to take advantage of the Docker’s layer caching mechanism. Here’s the Dockerfile for the <code>armv6</code> architecture:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> --platform=$BUILDPLATFORM nicoan/kindly-rss-builder AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /home</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH<span style=color:#f92672>=</span>$PATH:/build/cross-armv6/bin<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> CARGO_TARGET_ARM_UNKNOWN_LINUX_MUSLEABIHF_LINKER<span style=color:#f92672>=</span>arm-linux-musleabihf-gcc<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> rustup target add arm-unknown-linux-musleabihf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cargo build --target arm-unknown-linux-musleabihf --release<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:3 AS run</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /home/kindlyrss/static_data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> mkdir -p /home/kindlyrss/data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 3000/tcp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /home/target/arm-unknown-linux-musleabihf/release/kindle-rss-reader /usr/local/bin/kindlyrss<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /home/templates/ /home/kindlyrss/static_data/templates/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /home/migrations/ /home/kindlyrss/static_data/migrations/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /home/static/ /home/kindlyrss/static_data/static/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /home/config/config.json /home/kindlyrss/data/config.json<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> RUST_LOG<span style=color:#f92672>=</span>info
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENV</span> MAX_ARTICLES_QTY_TO_DOWNLOAD<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENV</span> STATIC_DATA_PATH<span style=color:#f92672>=</span>/home/kindlyrss/static_data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DATA_PATH<span style=color:#f92672>=</span>/home/kindlyrss/data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;kindlyrss&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The idea is to use a multi-stage build with two stages: <code>build</code> and <code>run</code>.</p><p>In the <code>build</code> stage:</p><ul><li>Line 1: We use <a href="https://www.notion.so/Cross-compiling-Rust-using-Docker-1a7a491da87e80f4a7b9e67ba2ebc738?pvs=21">the linkers image</a> with the <code>--platform=$BUILDPLATFORM</code> parameter to ensure that no emulation will be used in this stage.</li><li>Line 5: We add to the <code>$PATH</code> environment variable the path where the linker’s binaries are located.</li><li>Line 6: We tell cargo which linker we are going to use for compiling <code>armv6</code>. This can be done through <a href=https://doc.rust-lang.org/cargo/reference/config.html#environment-variables>environment variables</a> or <a href=https://doc.rust-lang.org/cargo/reference/config.html#configuration-format>with a configuration file</a>. The shape of the environment variables specifying the linker is <code>CARGO_TARGET_&lt;triple>_LINKER</code>. The format of the <a href=https://doc.rust-lang.org/cargo/commands/cargo-build.html#compilation-options><code>&lt;triple></code></a>  is <code>&lt;arch>&lt;sub>-&lt;vendor>-&lt;sys>-&lt;abi></code>.
The four environment variables used are:<ul><li><code>CARGO_TARGET_ARM_UNKNOWN_LINUX_MUSLEABIHF_LINKER</code> for <code>armv6</code></li><li><code>CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABIHF_LINKER</code> for <code>armv7</code></li><li><code>CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER</code> for <code>arm64v8</code></li><li><code>CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER</code> for <code>x86_64</code></li></ul></li><li>Line 8: We add the <code>arm-unknown-linux-musleabihf</code> target to be able to build the project for the <code>armv6</code> architecture using the musl C library.
The four targets used are:<ul><li><code>arm-unknown-linux-musleabihf</code> for <code>armv6</code></li><li><code>armv7-unknown-linux-musleabihf</code> for <code>armv7</code></li><li><code>aarch64-unknown-linux-musl</code> for <code>arm64v8</code></li><li><code>x86_64-unknown-linux-musl</code> for <code>x86_64</code></li></ul></li><li>Line 9: We copy the source.</li><li>Line 11: We build the project in release mode targeting the <code>armv6</code> architecture.</li></ul><p>The <code>run</code> stage will be built using <code>alpine</code> as base. This stage is the last one and will output the <a href="https://www.notion.so/Cross-compiling-Rust-using-Docker-1a7a491da87e80f4a7b9e67ba2ebc738?pvs=21">final image</a> for <code>armv6</code>. Here, we copy the binary file and all the files needed by it to run the application correctly from the <code>builder</code> stage, expose the port <code>3000</code> and set some configurations using environment variables. After that we execute the binary to run the application.</p><p>Note that in the Dockerfile is never specified the platform to be used. This is done using the <a href=https://docs.docker.com/build/building/multi-platform/#build-multi-platform-images><code>--platform</code> argument</a> in the <code>docker build</code> command.</p><p>The command used to build this image is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --tag nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --platform linux/arm/v6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -f ./dockerfiles/Dockerfile.armv6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    .
</span></span></code></pre></div><p>where <code>$(PACKAGE_VERSION)</code> is the app version.</p><h2 id=publishing-the-images>Publishing the images<a hidden class=anchor aria-hidden=true href=#publishing-the-images>#</a></h2><p>To publish the images we just need a <a href=https://hub.docker.com/>Docker Hub</a> account and use the <code>docker push</code> command. Since we are supporting more than one architecture, it would be nice to have all the images targeting different platforms grouped in the same tag. This can be achieved by pushing all the different images separately and then creating a manifest pointing at them under the same tag.</p><p>For example, for version <code>0.1.0</code>, we first push the four images:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker push nicoan/kindly-rss-reader:0.1.0-armx86_64
</span></span><span style=display:flex><span>docker push nicoan/kindly-rss-reader:0.1.0-arm64v8
</span></span><span style=display:flex><span>docker push nicoan/kindly-rss-reader:0.1.0-armv7
</span></span><span style=display:flex><span>docker push nicoan/kindly-rss-reader:0.1.0-armv6
</span></span></code></pre></div><p>After that we create a manifest file for the tag <code>0.1.0</code> attaching all the images that we just pushed to the hub:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker manifest create nicoan/kindly-rss-reader:0.1.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --amend nicoan/kindly-rss-reader:0.1.0-armx86_64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --amend nicoan/kindly-rss-reader:0.1.0-arm64v8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --amend nicoan/kindly-rss-reader:0.1.0-armv7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --amend nicoan/kindly-rss-reader:0.1.0-armv6
</span></span></code></pre></div><p>And push it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker manifest push nicoan/kindly-rss-reader:0.1.0
</span></span></code></pre></div><p>The same thing can be done with the <code>latest</code> tag with an extra step: we first need to delete its manifest and then re-create it with the images we want to group. If we don’t do the delete step, the new images will be grouped with all the previous ones.</p><h1 id=doing-all-this-process-semi-automatically>Doing all this process semi-automatically<a hidden class=anchor aria-hidden=true href=#doing-all-this-process-semi-automatically>#</a></h1><p>I am not good at remembering all the arguments and details of the commands I use. That’s why I usually try to create scripts to automate the processes. In this case I opted to use a good old <code>Makefile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#75715e># Extract the version from Cargo.toml
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>PACKAGE_VERSION<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>shell cat Cargo.toml | grep version | head -n <span style=color:#ae81ff>1</span> | awk <span style=color:#e6db74>&#39;{print $$3}&#39;</span> | sed -e <span style=color:#e6db74>&#39;s/&#34;//g&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build for different archs
</span></span></span><span style=display:flex><span><span style=color:#75715e># I opted to use multiple Dockerfiles to take advantage of the layer caching mechanism.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>docker-build</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--tag nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armx86_64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-f ./dockerfiles/Dockerfile.x86_64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--platform linux/amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		.
</span></span><span style=display:flex><span>	docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--tag nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-arm64v8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-f ./dockerfiles/Dockerfile.armv8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--platform linux/arm64/v8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		.
</span></span><span style=display:flex><span>	docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--tag nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--platform linux/arm/v6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-f ./dockerfiles/Dockerfile.armv6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		.
</span></span><span style=display:flex><span>	docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--tag nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--platform linux/arm/v7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-f ./dockerfiles/Dockerfile.armv7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Builds an image with different linkers to be able to build
</span></span></span><span style=display:flex><span><span style=color:#75715e># for different architectures
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>docker-prepare-build-image</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--tag nicoan/kindly-rss-builder <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		-f ./dockerfiles/Dockerfile.build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Push new versions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>docker-push</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Push different architecture images</span>
</span></span><span style=display:flex><span>	docker push nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armx86_64
</span></span><span style=display:flex><span>	docker push nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-arm64v8
</span></span><span style=display:flex><span>	docker push nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv7
</span></span><span style=display:flex><span>	docker push nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv6
</span></span><span style=display:flex><span>	<span style=color:#75715e># Create manifest for the package version and push</span>
</span></span><span style=display:flex><span>	docker manifest create nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armx86_64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-arm64v8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv6
</span></span><span style=display:flex><span>	docker manifest push nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># Create manifest for the latest tag and push</span>
</span></span><span style=display:flex><span>	docker manifest rm nicoan/kindly-rss-reader:latest
</span></span><span style=display:flex><span>	docker manifest create nicoan/kindly-rss-reader:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armx86_64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-arm64v8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		--amend nicoan/kindly-rss-reader:<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>-armv6
</span></span><span style=display:flex><span>	docker manifest push nicoan/kindly-rss-reader:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>git-tag-and-push</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	git tag v<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>	git push origin v<span style=color:#66d9ef>$(</span>PACKAGE_VERSION<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>.PHONY</span><span style=color:#f92672>:</span> build-docker docker-push docker-prepare-build-image git-tag-and-push
</span></span></code></pre></div><p>This way, I just have to write in the terminal</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make docker-prepare-build-image
</span></span><span style=display:flex><span>make docker-build
</span></span><span style=display:flex><span>make docker-push
</span></span></code></pre></div><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>Using Docker to cross-compile Rust projects ensures portability and ease of deployment. This process could be used in some CI/CD pipeline fully automate the process.</p><h1 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h1><ol><li><a href=https://docs.docker.com/build/building/multi-platform/>https://docs.docker.com/build/building/multi-platform/</a></li><li><a href=https://doc.rust-lang.org/cargo/reference/config.html>https://doc.rust-lang.org/cargo/reference/config.html</a></li><li><a href=https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/>https://www.docker.com/blog/multi-arch-build-and-images-the-simple-way/</a></li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Compressed docker images are around 3.5 MBs while Debian stable slim are around 25MBs.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://nicoan.net/tags/rust/>Rust</a></li><li><a href=https://nicoan.net/tags/cross-compiling/>Cross-Compiling</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on x" href="https://x.com/intent/tweet/?text=Cross%20compiling%20Rust%20using%20Docker&amp;url=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f&amp;hashtags=rust%2ccross-compiling"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f&amp;title=Cross%20compiling%20Rust%20using%20Docker&amp;summary=Cross%20compiling%20Rust%20using%20Docker&amp;source=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f&title=Cross%20compiling%20Rust%20using%20Docker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on whatsapp" href="https://api.whatsapp.com/send?text=Cross%20compiling%20Rust%20using%20Docker%20-%20https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on telegram" href="https://telegram.me/share/url?text=Cross%20compiling%20Rust%20using%20Docker&amp;url=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cross compiling Rust using Docker on ycombinator" href="https://news.ycombinator.com/submitlink?t=Cross%20compiling%20Rust%20using%20Docker&u=https%3a%2f%2fnicoan.net%2fposts%2fcross_compiling_using_docker%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://nicoan.net/>Nico Antinori</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>