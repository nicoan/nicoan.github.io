<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Posts on Nico Antinori</title>
    <link>https://nicoan.github.io/posts/</link>
    <description>Recent content in Posts on Nico Antinori</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Sun, 24 Mar 2024 12:00:00 -0300</lastBuildDate>
    <atom:link href="https://nicoan.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Rust references and borrowing from the inside</title>
      <link>https://nicoan.github.io/posts/references_and_borrowing/</link>
      <pubDate>Sun, 24 Mar 2024 12:00:00 -0300</pubDate>
      <guid>https://nicoan.github.io/posts/references_and_borrowing/</guid>
      <description>Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.
GDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:</description>
      <content:encoded><![CDATA[<p>Now it is time to talk about references and borrowing. To understand this topic, first check out this <a href="/posts/move_semantics/">post</a> where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.</p>
<h3 id="gdb">GDB</h3>
<p>In this post I am going to explore what is happening in memory using the <a href="https://en.wikipedia.org/wiki/GNU_Debugger">GNU Debugger (gdb)</a> with the special command <code>rust-gdb</code>:</p>
<h1 id="what-is-a-reference-in-rust">What is a reference in Rust?</h1>
<p>A reference is a value that points to data in memory. Although it is similar to a classic pointer there is a crucial difference between the two: a reference is guaranteed to always point to a memory address that contains a valid piece of data whereas pointers are not¹. The checks performed to guarantee that a reference is always valid is done at <strong>compile time</strong>.</p>
<p>Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a new value, with s1 as owner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a reference of s1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>s1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Print the s2 value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, s2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code compiles and runs correctly. What happens in memory? Let’s check it out with GDB!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, references_and_borrowing::main <span style="color:#f92672">()</span> at src/main.rs:3
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>           let s1 <span style="color:#f92672">=</span> String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello world!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> n
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>           let s2 <span style="color:#f92672">=</span> &amp;s1;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> n
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>           println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, s2<span style="color:#f92672">)</span>;
</span></span></code></pre></div><p>At this point, the <code>String</code> <code>s1</code> is initialized with the text <code>&quot;hello world!</code> and the <code>s1</code>&rsquo;s reference named <code>s2</code> is set. Let&rsquo;s check the stack:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x7fffffffd920: <span style="color:#ae81ff">56</span>      <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd928: <span style="color:#ae81ff">112</span>     <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd930: <span style="color:#ae81ff">32</span>      <span style="color:#ae81ff">208</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">247</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd938: <span style="color:#ae81ff">160</span>     <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd940: <span style="color:#ae81ff">12</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd948: <span style="color:#ae81ff">12</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd950: <span style="color:#ae81ff">56</span>      <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd958: <span style="color:#ae81ff">128</span>     <span style="color:#ae81ff">167</span>     <span style="color:#ae81ff">218</span>     <span style="color:#ae81ff">247</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd960: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd968: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The lines 4 to 6 is the representation of s1 in the stack: <code>0x7fffffffd938</code> is <strong><code>ptr</code></strong>, <code>0x7fffffffd940</code> is <strong><code>len</code></strong> and <code>0x7fffffffd948</code> is <strong><code>capacity</code></strong>. The reference to <code>s1</code> is located at <code>0x7fffffffd950</code>. Let&rsquo;s print the address value in hexadecimal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd950
</span></span><span style="display:flex;"><span>0x7fffffffd950: 0x00007fffffffd938
</span></span></code></pre></div><p>As we can see, the value contained in the address <code>0x7fffffffd950</code> is <code>0x00007fffffffd938</code>², the beginning of the <code>s1</code>&rsquo;s stack representation!</p>
<p><img loading="lazy" src="/images/references_and_borrowing/reference.png#center" alt="Reference un memory"  />
</p>
<p>¹ An invalid memory region refers to a region that was not assigned to our process or memory that was valid at some point of the program execution but then was freed. <br>
² Zeroes are trimmed for legibility when printed as a memory address by GDB.</p>
<h2 id="the-two-rules-of-references">The two rules of references</h2>
<p>As everything in Rust, references have their own set of rules.</p>
<ol>
<li>References are always valid.</li>
<li>At any given time we either have any number of immutable references or one mutable reference.</li>
</ol>
<h3 id="references-are-always-valid">References are always valid</h3>
<p>There&rsquo;s no way of testing this rule at runtime (or at least I don&rsquo;t know one). As I stated earlier in this post, references are guaranteed to always be valid and this validation is done at compile time.</p>
<h3 id="at-any-given-time-we-either-have-any-number-of-immutable-references-or-one-mutable-reference">At any given time we either have any number of immutable references or one mutable reference</h3>
<p>At first glance, this rule feels like an unnecessary limitation but thanks to it we are able to catch hidden bugs in our code because <a href="https://en.wikipedia.org/wiki/Race_condition#Data_race">data races</a> are avoided at compile time.</p>
<p>A classic example is the one where we have <code>n</code> mutable references of the same piece of numeric data that represents a counter, all in different threads. The only thing the threads do is increment the counter. References by themselves do not have a synchronization mechanism. This is the concurrent counter problem, <a href="https://knowledgebasement.com/what-are-concurrency-problems-and-how-to-avoid-them-in-java/">here&rsquo;s the whole explanation and an example code in Java</a>. This can&rsquo;t happen in Rust (code won&rsquo;t compile) since we need some kind of <a href="https://doc.rust-lang.org/std/sync/struct.Mutex.html">synchronization mechanism</a> to mutate the same piece of data in different threads.</p>
<p>This is not the only problem this rule keeps us away from! In fact, we don&rsquo;t even need concurrency, it can avoid bugs in simpler situations. Consider the following code in python:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">insert_even_zeros</span>(vec):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (n,i) <span style="color:#f92672">in</span> enumerate(vec):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> n <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            vec<span style="color:#f92672">.</span>insert(i, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vec <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">7</span>)) <span style="color:#75715e"># [1, 2, 3, 4, 5, 6]</span>
</span></span><span style="display:flex;"><span>print(vec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>What we are trying to do here is to insert a <code>0</code> at the index of a value, if the value is an even number. The expected result for the input <code>[1, 2, 3, 4, 5, 6]</code> is <code>[1, 0, 2, 3, 0, 4, 5, 0, 6]</code> but if we run it, we get <code>[1, 0, 0, 0, 0, 0, 0, 2, 3, 4, 5, 6]</code>. What is happening? The source of the problem resides in the fact that we are mutating the vector while iterating it:</p>
<ol>
<li>We start at index <code>0</code> where the value <code>1</code> is located, since <code>1</code> is not even we continue to index <code>1</code>.</li>
<li>At index <code>1</code> we find value <code>2</code>. It is even so we insert a <code>0</code> at index <code>1</code>. Now the array is: <code>[1, 0, 2, 3, 4, 5, 6]</code>. We continue to index <code>2</code>.</li>
<li>At index <code>2</code> we find the value <code>2</code> again, because it was moved from its original position in the previous iteration. It is even so we insert a <code>0</code> at index <code>2</code>. Now the array is: <code>[1, 0, 0, 2, 3, 4, 5, 6]</code>.</li>
<li>This process is repeated 4 more times since the array length is 6 and how many iterations are going to be executed is calculated at the beginning of the <code>for</code> statement.</li>
</ol>
<p>This is known as the <em>iterator invalidation</em> problem.</p>
<p>What happens in Rust?</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">insert_even_zeros</span>(vec: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i, n) <span style="color:#66d9ef">in</span> vec.iter().enumerate() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> n <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>            vec.insert(i, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> v: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..=</span><span style="color:#ae81ff">6</span>).collect(); <span style="color:#75715e">// [1, 2, 3, 4, 5, 6]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    insert_even_zeros(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> v);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>We get a compilation error that enforces the rule!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>error<span style="color:#f92672">[</span>E0502<span style="color:#f92672">]</span>: cannot borrow <span style="color:#e6db74">`</span>*vec<span style="color:#e6db74">`</span> as mutable because it is also borrowed as immutable
</span></span><span style="display:flex;"><span> --&gt; src/main.rs:4:13
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> |     <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i, n<span style="color:#f92672">)</span> in vec.iter<span style="color:#f92672">()</span>.enumerate<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  |                   ----------------------
</span></span><span style="display:flex;"><span>  |                   |
</span></span><span style="display:flex; background-color:#3c3d38"><span>  |                   immutable borrow occurs here
</span></span><span style="display:flex; background-color:#3c3d38"><span>  |                   immutable borrow later used here
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> |         <span style="color:#66d9ef">if</span> n % 2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> |             vec.insert<span style="color:#f92672">(</span>i, 0<span style="color:#f92672">)</span>;
</span></span><span style="display:flex; background-color:#3c3d38"><span>  |             ^^^^^^^^^^^^^^^^ mutable borrow occurs here
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For more information about this error, try <span style="color:#e6db74">`</span>rustc --explain E0502<span style="color:#e6db74">`</span>.
</span></span></code></pre></div><p>Where are the mutable and immutable references? In the vector&rsquo;s function signatures:</p>
<ul>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.iter"><code>.iter()</code></a> takes an immutable reference of the vector (<code>&amp;self</code>):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">iter</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#a6e22e">Iter</span><span style="color:#f92672">&lt;</span>&#39;_, T<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><ul>
<li><a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.insert"><code>.insert()</code></a> takes a mutable reference of the vector (<code>&amp;mut self</code>):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">insert</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, index: <span style="color:#66d9ef">usize</span>, element: <span style="color:#a6e22e">T</span>)
</span></span></code></pre></div><p>Does this mean that there&rsquo;s no way of modifying a vector in Rust while iterating it? No! You can do it:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> v: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..=</span><span style="color:#ae81ff">6</span>).collect();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> i: <span style="color:#66d9ef">usize</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">let</span> v_len <span style="color:#f92672">=</span> v.len();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> i <span style="color:#f92672">&lt;</span> v_len {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> v[i] <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span>            v.insert(i, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>We also have two references, one immutable (<code>len</code> function) and one mutable (<code>insert</code> function). Why does it work? Because the scope of the immutable reference that is in <code>len</code> ends right after it the function is used (the scope of a reference begins at its creation and extends until the last time the reference is used).</p>
<p>Notice that the error message we got with the <code>for</code> loop says &ldquo;<code>immutable borrow occurs here</code>&rdquo; and &ldquo;<code>immutable borrow later used here</code>&rdquo;. Both errors come from the same place, the <code>iter()</code> function, where the immutable reference is used.</p>
<p>Does it make sense for a programming language to have these kinds of rules if it is possible to write code to circumvent them? Yes! The way the last code is written is rather &ldquo;unnatural&rdquo;. Most of the time Rust will catch bugs at compile time thanks to these rules.</p>
<h1 id="borrowing">Borrowing</h1>
<p>There are times when you don&rsquo;t want a specific scope to lose ownership of a value. There could be several reasons for that, for example, you need to reuse the value. Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>(s: String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;hello </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bye</span>(s: String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;bye </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;fellow blog reader&#34;</span>);
</span></span><span style="display:flex;"><span>    hello(s);
</span></span><span style="display:flex;"><span>    bye(s);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code won&rsquo;t compile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>error<span style="color:#f92672">[</span>E0382<span style="color:#f92672">]</span>: use of moved value: <span style="color:#e6db74">`</span>s<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>  --&gt; src/main.rs:12:9
</span></span><span style="display:flex;"><span>   |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> |     let s <span style="color:#f92672">=</span> String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fellow blog reader&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>   |         - move occurs because <span style="color:#e6db74">`</span>s<span style="color:#e6db74">`</span> has type <span style="color:#e6db74">`</span>String<span style="color:#e6db74">`</span>, which does not implement the <span style="color:#e6db74">`</span>Copy<span style="color:#e6db74">`</span> trait
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span> |     hello<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>   |           - value moved here
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span> |     bye<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>   |         ^ value used here after move
</span></span><span style="display:flex;"><span>   |
</span></span><span style="display:flex;"><span>note: consider changing this parameter type in <span style="color:#66d9ef">function</span> <span style="color:#e6db74">`</span>hello<span style="color:#e6db74">`</span> to borrow instead <span style="color:#66d9ef">if</span> owning the value isn<span style="color:#960050;background-color:#1e0010">&#39;</span>t necessary
</span></span><span style="display:flex;"><span>  --&gt; src/main.rs:1:13
</span></span><span style="display:flex;"><span>   |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>  | fn hello<span style="color:#f92672">(</span>s: String<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   |    -----    ^^^^^^ this parameter takes ownership of the value
</span></span><span style="display:flex;"><span>   |    |
</span></span><span style="display:flex;"><span>   |    in this <span style="color:#66d9ef">function</span>
</span></span><span style="display:flex;"><span>help: consider cloning the value <span style="color:#66d9ef">if</span> the performance cost is acceptable
</span></span><span style="display:flex;"><span>   |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span> |     hello<span style="color:#f92672">(</span>s.clone<span style="color:#f92672">())</span>;
</span></span><span style="display:flex;"><span>   |            ++++++++
</span></span></code></pre></div><p>Here we have a similar situation as we had <a href="/posts/move_semantics/#rule-2-theres-only-one-owner-per-value">here</a>. As the compiler error says, we are moving <code>s</code> into <code>hello</code>, so when we try to use it in <code>bye</code> we get the <a href="https://doc.rust-lang.org/error_codes/E0382.html">&ldquo;use after move&rdquo;</a> error. How can we solve this?</p>
<h3 id="solution-1-duplicating-the-value">Solution 1: Duplicating the value</h3>
<p>We can do as the compiler says, and <a href="https://doc.rust-lang.org/std/clone/trait.Clone.html">clone</a> the value. This way, both functions get a separate copy of the value that they can own:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>(s: String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;hello </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bye</span>(s: String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;bye </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;fellow blog reader&#34;</span>);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    hello(s.clone());
</span></span><span style="display:flex;"><span>    bye(s);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>This works! the code compiles and executes without a warning. Is this a good solution? No.</p>
<p>We don&rsquo;t really need to duplicate <code>s</code> since we are only reading it to print it out. This solution does a lot of extra work by duplicating <code>s</code>&rsquo;s value in memory.</p>
<h3 id="solution-2-returning-the-ownership-back-to-the-caller">Solution 2: Returning the ownership back to the caller</h3>
<p>Instead of duplicating <code>s</code>&rsquo;s value, we can return the ownership to the caller, so it can use it again:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-rust" data-lang="rust"><span style="display:flex; background-color:#3c3d38"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>(s: String) -&gt; String {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;hello </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    s
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bye</span>(s: String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;bye </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;fellow blog reader&#34;</span>);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> hello(s);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    bye(s2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>This also works! the code compiles and executes without a warning. Is this a good solution? Also no.</p>
<p>Passing ownership back and forth functions is not a very comfortable and idiomatic way of doing things. On top of that, the function signatures are not semantically accurate. The signature of <code>hello</code> suggests that we pass an <code>String</code> value and returns back another <code>String</code> value. By just looking at it, it is hard to understand what the function intends to do and it does not make sense to return anything if the only objective of the function is only to print something.</p>
<h3 id="solution-3-borrowing">Solution 3: Borrowing</h3>
<p>We need to keep the ownership of <code>s</code> in the scope of the <code>main</code> function, we don&rsquo;t want to duplicate values and we don&rsquo;t want to move the values back and forth either. What can we do? use <a href="/posts/references_and_borrowing/#what-is-a-reference-in-rust">a reference</a>!</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello</span>(s: <span style="color:#66d9ef">&amp;</span>String) {
</span></span><span style="display:flex; background-color:#3c3d38"><span>    println!(<span style="color:#e6db74">&#34;hello </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">bye</span>(s: <span style="color:#66d9ef">&amp;</span>String) {
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;bye </span><span style="color:#e6db74">{s}</span><span style="color:#e6db74">.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;fellow blog reader&#34;</span>);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    hello(<span style="color:#f92672">&amp;</span>s);
</span></span><span style="display:flex; background-color:#3c3d38"><span>    bye(<span style="color:#f92672">&amp;</span>s);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code compiles and executes without a warning. Is this a good solution? Yes.</p>
<p>Given that we only need to read the value, we don&rsquo;t want to move it or duplicate it, using a reference is the best solution. Also, it is more idiomatic and semantically correct. By looking at the function&rsquo;s signatures we know that they do not need to own any value and they will not return any result from the operation they are performing.</p>
<p>Let&rsquo;s now check what is happening in the memory with GDB:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, references_and_borrowing::main <span style="color:#f92672">()</span> at src/main.rs:10
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span>          let s <span style="color:#f92672">=</span> String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fellow blog reader&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> n
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span>          hello<span style="color:#f92672">(</span>&amp;s<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80ub $sp
</span></span><span style="display:flex;"><span>0x7fffffffd970: <span style="color:#ae81ff">2</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd978: <span style="color:#ae81ff">128</span>     <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd980: <span style="color:#ae81ff">160</span>     <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd988: <span style="color:#ae81ff">18</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd990: <span style="color:#ae81ff">18</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd998: <span style="color:#ae81ff">48</span>      <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9a0: <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9a8: <span style="color:#ae81ff">59</span>      <span style="color:#ae81ff">216</span>     <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b0: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">240</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b8: <span style="color:#ae81ff">48</span>      <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looks like our <code>String</code> representation in the stack starts at <code>0x7fffffffd980</code>. Let&rsquo;s confirm it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd980
</span></span><span style="display:flex;"><span>0x7fffffffd980: 0x00005555555afba0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/18c 0x00005555555afba0
</span></span><span style="display:flex;"><span>0x5555555afba0: <span style="color:#ae81ff">102</span> <span style="color:#e6db74">&#39;f&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span> <span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span> <span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span> <span style="color:#ae81ff">119</span> <span style="color:#e6db74">&#39;w&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">98</span> <span style="color:#e6db74">&#39;b&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555afba8: <span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span> <span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span> <span style="color:#ae81ff">103</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">97</span> <span style="color:#e6db74">&#39;a&#39;</span>  <span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555afbb0: <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span>
</span></span></code></pre></div><p>Excellent, now let&rsquo;s continue with the program execution and check what&rsquo;s in <code>hello</code> function&rsquo;s stack:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 2, references_and_borrowing::hello <span style="color:#f92672">(</span>s<span style="color:#f92672">=</span>0x7fffffffd980<span style="color:#f92672">)</span> at src/main.rs:2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>           println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello {s}.&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80ub $sp
</span></span><span style="display:flex;"><span>0x7fffffffd900: <span style="color:#ae81ff">128</span>     <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd908: <span style="color:#ae81ff">140</span>     <span style="color:#ae81ff">201</span>     <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd910: <span style="color:#ae81ff">32</span>      <span style="color:#ae81ff">208</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">247</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd918: <span style="color:#ae81ff">128</span>     <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd920: <span style="color:#ae81ff">128</span>     <span style="color:#ae81ff">217</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd928: <span style="color:#ae81ff">154</span>     <span style="color:#ae81ff">177</span>     <span style="color:#ae81ff">222</span>     <span style="color:#ae81ff">247</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd930: <span style="color:#ae81ff">160</span>     <span style="color:#ae81ff">251</span>     <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd938: <span style="color:#ae81ff">18</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd940: <span style="color:#ae81ff">18</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd948: <span style="color:#ae81ff">213</span>     <span style="color:#ae81ff">192</span>     <span style="color:#ae81ff">89</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd920
</span></span><span style="display:flex;"><span>0x7fffffffd920: 0x00007fffffffd980
</span></span></code></pre></td></tr></table>
</div>
</div><p>At <code>0x7fffffffd920</code> found a pointer pointing to <code>s</code> in <code>main</code>&rsquo;s stack (<code>0x7fffffffd920: 0x00007fffffffd980</code>)! We can confirm that the whole representation still belongs to <code>main</code>&rsquo;s scope and, in <code>hello</code> and <code>bye</code> functions, we are just referencing it. <code>s</code>memory will be freed once <code>main</code> finishes.</p>
<p><img loading="lazy" src="/images/references_and_borrowing/s_string.png#center" alt="Borrowing in memory"  />
</p>
<p>There&rsquo;s no need to change the scope to borrow a value: the <a href="/posts/references_and_borrowing/#what-is-a-reference-in-rust">code used in the previous section</a>, is just a slight modification of an <a href="/posts/move_semantics/#rule-2-theres-only-one-owner-per-value">example used in a previous post</a> that did not compile. We fixed it by borrowing <code>s1</code>&rsquo;s value to <code>s2</code>.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Sometimes we have a hard time fighting the Rust compiler because it usually fails with errors that do not exist in other programming languages. Those errors feel arbitrary but, as we have seen in this post, they are there to protect us. It can take some time to wrap your head around them.</p>
<p>The more you code in Rust, the less you fight with the compiler and you end up with more performant and more secure programs. Also, a lot of errors are catched at compile time, saving us a lot of precious debugging time.</p>
<p>This post concludes a series of post about how Rust handles memory the internals of it:</p>
<ol>
<li><a href="/posts/stack_and_heap/">Stack and Heap</a></li>
<li><a href="/posts/move_semantics/">Rust ownership and move semantics from the inside</a></li>
<li><a href="/posts/references_and_borrowing/">Rust references and borrowing from the inside</a></li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>Rust ownership and move semantics from the inside</title>
      <link>https://nicoan.github.io/posts/move_semantics/</link>
      <pubDate>Tue, 18 Oct 2022 12:00:00 -0300</pubDate>
      <guid>https://nicoan.github.io/posts/move_semantics/</guid>
      <description>Ownership and move semantics is one of the things that makes Rust unique. To understand this topic, you need to understand what Stack and Heap are at a basic level. I wrote a post about that! You can check it out if you need a refresher on those concepts. It is a little bit hard to get used to this feature because it forces you to think about stuff that you didn&amp;rsquo;t have to worry about in other languages.</description>
      <content:encoded><![CDATA[<p>Ownership and move semantics is one of the things that makes Rust unique. To understand this topic, you need to understand what Stack and Heap are at a basic level. I wrote a <a href="/posts/stack_and_heap/">post</a> about that! You can check it out if you need a refresher on those concepts. It is a little bit hard to get used to this feature because it forces you to think about stuff that you didn&rsquo;t have to worry about in other languages. Enough introduction, let&rsquo;s cut to the chase!</p>
<h1 id="the-three-rules-of-ownership">The three rules of ownership</h1>
<p>There are three rules that governs the ownership system:</p>
<ol>
<li><strong>Every initialized value has an owner</strong>: Every initialized value has a variable that is its owner.¹</li>
<li><strong>There is only <em>one</em> owner per value</strong>: You can&rsquo;t have two or more variables that owns <em>the same</em> value in memory. You can&rsquo;t share ownership between variables.²</li>
<li><strong>If a variable&rsquo;s scope ends, its value gets freed</strong>: When a scope ends, all values owned by variables contained in that scope get automatically freed.</li>
</ol>
<p>¹ But not every variable owns a value, they may just hold a reference. I&rsquo;ll talk about this in the &ldquo;References and Borrowing&rdquo; article. <br>
² Actually you can have more than one owner in safe Rust. You have to use special structures, such as <a href="https://doc.rust-lang.org/stable/std/rc/struct.Rc.html">Rc</a> (multiple owners do not own the value directly though).</p>
<p>Let&rsquo;s test the rules! But before that, a little reminder of how the <code>String</code> type is represented in memory:</p>
<p><img loading="lazy" src="/images/move_semantics/string_repr.png#center" alt="String representation in memory"  />
</p>
<p>where:</p>
<ul>
<li><strong>ptr</strong>: A pointer to the first direction of the Heap containing the string itself (in this case <code>hello</code>).</li>
<li><strong>len</strong>: How much memory, in bytes, the contents of the string is currently using.</li>
<li><strong>capacity</strong>: The total amount of memory, in bytes, allocated for that string.</li>
</ul>
<h3 id="gdb">GDB</h3>
<p>In this post, I am going to explore what is happening in memory using the <a href="https://en.wikipedia.org/wiki/GNU_Debugger">GNU Debugger (gdb)</a> with the special command <code>rust-gdb</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ rust-gdb ./target/debug/move_semantics
</span></span></code></pre></div><p>I am going to use the <a href="https://visualgdb.com/gdbreference/commands/x">x command</a> a lot to explore the stack and the <code>$sp</code> value (refers to the Stack Pointer).</p>
<h2 id="rule-1-every-initialized-value-has-an-owner">Rule 1: Every initialized value has an owner.</h2>
<p>Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello_world</span>() -&gt; <span style="color:#66d9ef">u32</span> {
</span></span><span style="display:flex;"><span>    String::from(<span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span>);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    hello_world();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>hello_world</code> function, we have an initialized String  value that is free (not assigned to a variable). Did Rust initialize the value in memory or just ignore it? We can&rsquo;t use it so&hellip; Why would Rust save it? Let&rsquo;s check what happens! When we compile this code we get the following warning:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>warning: unused <span style="color:#66d9ef">return</span> value of <span style="color:#e6db74">`</span>from<span style="color:#e6db74">`</span> that must be used
</span></span><span style="display:flex;"><span> --&gt; src/main.rs:2:5
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> |     String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">=</span> note: <span style="color:#e6db74">`</span><span style="color:#75715e">#[warn(unused_must_use)]` on by default</span>
</span></span></code></pre></div><p>Rust warns us that we must use the returned value of the <code>String::from</code> function, otherwise, we can&rsquo;t access it in any way. What happens in memory? Let&rsquo;s check it out with GDB!</p>
<p>First, we set a breakpoint at the beginning of the <code>hello_world</code> function and execute the <code>String</code> initialization:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, move_semantics::hello_world <span style="color:#f92672">()</span> at src/main.rs:2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>           String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> n
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>           println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, 42<span style="color:#f92672">)</span>;
</span></span></code></pre></div><p>At this point, the <code>String</code> is initialized, but it isn&rsquo;t assigned to a variable. So, it has no owner! Let&rsquo;s check the stack:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80ub $sp
</span></span><span style="display:flex;"><span>0x7fffffffd980: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">240</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd988: <span style="color:#ae81ff">61</span>      <span style="color:#ae81ff">60</span>      <span style="color:#ae81ff">87</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd990: <span style="color:#ae81ff">16</span>      <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd998: <span style="color:#ae81ff">38</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd9a0: <span style="color:#ae81ff">38</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9a8: <span style="color:#ae81ff">2</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b0: <span style="color:#ae81ff">48</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b8: <span style="color:#ae81ff">96</span>      <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9c0: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">240</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9c8: <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It seems that the <code>String</code> value is there, lines 4 to 6 looks like our initialized value: memory addresses <code>0x7fffffffd998</code> and <code>0x7fffffffd9a0</code> (lines 5 and 6) have a 38 stored, and the string happens to have 38 characters. <code>0x7fffffffd990</code> (line 4) must be the Heap address where the actual text is allocated! Let&rsquo;s see what&rsquo;s inside that memory address.</p>
<p>First, print the address as hexa:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd990
</span></span><span style="display:flex;"><span>0x7fffffffd990:	0x00005555555a5a10
</span></span></code></pre></div><p>Then, explore what&rsquo;s inside that address!</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/38cb 0x00005555555a5a10
</span></span><span style="display:flex;"><span>0x5555555a5a10: <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a18: <span style="color:#ae81ff">16</span> <span style="color:#e6db74">&#39;\020&#39;</span>       <span style="color:#ae81ff">80</span> <span style="color:#e6db74">&#39;P&#39;</span>  <span style="color:#ae81ff">90</span> <span style="color:#e6db74">&#39;Z&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a20: <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">110</span> <span style="color:#e6db74">&#39;n&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">116</span> <span style="color:#e6db74">&#39;t&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a28: <span style="color:#ae81ff">97</span> <span style="color:#e6db74">&#39;a&#39;</span>  <span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">122</span> <span style="color:#e6db74">&#39;z&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">83</span> <span style="color:#e6db74">&#39;S&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a30: <span style="color:#ae81ff">116</span> <span style="color:#e6db74">&#39;t&#39;</span> <span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">110</span> <span style="color:#e6db74">&#39;n&#39;</span> <span style="color:#ae81ff">103</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#ae81ff">33</span> <span style="color:#e6db74">&#39;!&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our <code>String</code> is <strong>mostly</strong> there! But, it appears that the beginning of it was overwritten. It&rsquo;s ok, that value isn&rsquo;t owned by any variable; we can&rsquo;t access it. So, it doesn&rsquo;t matter what happens to it.</p>
<p><strong>NOTE</strong>: This memory exploration was done using a <em>debug</em> build. I am not really sure what happens if this code was compiled in <em>release</em> mode. I believe that Rust does not initialize the value as an optimization, because it is not used.</p>
<h2 id="rule-2-theres-only-one-owner-per-value">Rule 2: There&rsquo;s only one owner per value</h2>
<p>Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a new value, with s1 as owner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Move ownership from s1 to s2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Oops! compiler error, the value has been moved!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, s1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we try to compile this, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>error<span style="color:#f92672">[</span>E0382<span style="color:#f92672">]</span>: borrow of moved value: <span style="color:#e6db74">`</span>s1<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span> --&gt; src/main.rs:7:20
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> |     let s1 <span style="color:#f92672">=</span> String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello world!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |         -- move occurs because <span style="color:#e6db74">`</span>s1<span style="color:#e6db74">`</span> has type <span style="color:#e6db74">`</span>String<span style="color:#e6db74">`</span>, which does not implement the <span style="color:#e6db74">`</span>Copy<span style="color:#e6db74">`</span> trait
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> |     // Move ownership from s1 to s2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span> |     let s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>  |              -- value moved here
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> |     // Oops! compiler error, the value has been moved!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span> |     println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, s1<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |                    ^^ value borrowed here after move
</span></span></code></pre></div><p>What is happening here is that the ownership of the <code>String</code> <code>&quot;hello world!&quot;</code> is transferred from <code>s1</code> to <code>s2</code>. Because of that, the compiler invalidates the access to <code>s1</code>.</p>
<p>The value was moved because the type <code>String</code> does not implement the <a href="https://doc.rust-lang.org/std/marker/trait.Copy.html">Copy</a> trait. This is used on types that can be <em>fully</em> allocated in the stack and can be duplicated by simply copying bits without much overload (duplicating data in the Heap is much more complicated). When a type implements the <code>Copy</code> trait, instead of having &ldquo;move semantics&rdquo; it has &ldquo;copy semantics&rdquo;. This is usally the case for primitive types:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n2 <span style="color:#f92672">=</span> n1;
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, n1);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, n1, n2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we run this code&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo run
</span></span><span style="display:flex;"><span>   Compiling move_semantics v0.1.0 <span style="color:#f92672">(</span>/home/rust/blog<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 0.30s
</span></span><span style="display:flex;"><span>     Running <span style="color:#e6db74">`</span>target/debug/move_semantics<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span>
</span></span></code></pre></div><p>compiles! Because the value <code>42</code> is copied!</p>
<h2 id="rule-3-if-a-variables-scope-ends-its-value-gets-freed">Rule 3: If a variable&rsquo;s scope ends its value gets freed</h2>
<p>Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Create a new value with s1 as owner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e">// s1 gets dropped here! since is the end of the scope
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Checking drop with gdb!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>s1</code> allocation will have been freed when we reach line 7. This is because the curly braces at the beggining of the <code>main</code> function creates a new scope. Once the code reaches the end of it, all the variables that it contained get dropped. Let&rsquo;s check it out in GDB:</p>
<p>On line 4, we can find <code>s1</code> in the locals variables of the scope:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, move_semantics::main <span style="color:#f92672">()</span> at src/main.rs:4
</span></span><span style="display:flex;"><span>4	        println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, s1<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>s1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s check where the Heap allocation of <code>s1</code> is and what value it contains (remember that the first field of the Stack representation is the pointer to the Heap):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s1
</span></span><span style="display:flex;"><span>$1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffd960
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd960
</span></span><span style="display:flex;"><span>0x7fffffffd960:	0x00005555555a5ad0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/12c 0x00005555555a5ad0
</span></span><span style="display:flex;"><span>0x5555555a5ad0:	<span style="color:#ae81ff">104</span> <span style="color:#e6db74">&#39;h&#39;</span>	<span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>	<span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>	<span style="color:#ae81ff">119</span> <span style="color:#e6db74">&#39;w&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5ad8:	<span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span>	<span style="color:#ae81ff">33</span> <span style="color:#e6db74">&#39;!&#39;</span>
</span></span></code></pre></div><p>But when the scope finishes&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>7	    println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Checking drop with gdb!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>No locals.
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/12c 0x00005555555a5ad0
</span></span><span style="display:flex;"><span>0x5555555a5ad0:	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5ad8:	<span style="color:#ae81ff">16</span> <span style="color:#e6db74">&#39;\020&#39;</span>	<span style="color:#ae81ff">80</span> <span style="color:#e6db74">&#39;P&#39;</span>	<span style="color:#ae81ff">90</span> <span style="color:#e6db74">&#39;Z&#39;</span>	<span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>
</span></span></code></pre></div><p>All the locals variables were dropped and the memory occupied by them freed! That part of the Heap is now filled with something else (probably garbage).</p>
<h1 id="moving-a-value-what-happens-under-the-hood">Moving a value: What happens under the hood?</h1>
<p>Consider the following code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">move_stack_example</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a new String value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Move it from s1 to s2 (s2 takes ownership)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, s2);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    move_stack_example();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we move a value, it does not dissapears from the memory, instead, whatever is in the stack that belongs to the moved value gets duplicated and the compiler just forbids us from accessing the old variable ever again.</p>
<p><img loading="lazy" src="/images/move_semantics/under_the_hood.png#center" alt="Under the hood"  />
</p>
<p>Let&rsquo;s verify what I just said with GDB. We are going to examine the stack frame of the <code>move_stack_example</code> function. First of all, let&rsquo;s check the locals variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>s2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span><span style="display:flex;"><span>s1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span></code></pre></div><p>Whoa! Looks like <code>s1</code> and <code>s2</code> have the same value! Actually they are <strong>pointing</strong> to the same value. Let&rsquo;s now see what the addresses of <code>s1</code> and <code>s2</code> are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s1
</span></span><span style="display:flex;"><span>$1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffdb08
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s2
</span></span><span style="display:flex;"><span>$2 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffdb20
</span></span></code></pre></div><p>Great! Now, we know that <code>s1</code>&rsquo;s stack representation starts at <code>0x7fffffffdb08</code> and <code>s2</code>&rsquo;s starts at <code>0x7fffffffdb20</code>. Let&rsquo;s now see the contents of the stack frame:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80bu $sp
</span></span><span style="display:flex;"><span>0x7fffffffdaf0:	112	171	217	247	255	127	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdaf8:	7	125	221	247	255	127	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdb00:	2	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb08:	208	90	90	85	85	85	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb10:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb18:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb20:	208	90	90	85	85	85	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb28:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb30:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdb38:	0	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What do we have at <code>s1</code> and <code>s2</code> addresses? Let&rsquo;s check it out!:</p>
<ul>
<li><strong>ptr</strong>:
<ul>
<li>For <code>s1</code> this value is at <code>0x7fffffffdb08</code>.</li>
<li>For <code>s2</code> this value is at <code>0x7fffffffdb20</code>.</li>
</ul>
</li>
<li><strong>len</strong>:
<ul>
<li>For <code>s1</code> this value is at <code>0x7fffffffdb10</code>.</li>
<li>For <code>s2</code> this value is at <code>0x7fffffffdb28</code>.</li>
</ul>
</li>
<li><strong>capacity</strong>:
<ul>
<li>For <code>s1</code> this value is at <code>0x7fffffffdb18</code>.</li>
<li>For <code>s2</code> this value is at <code>0x7fffffffdb30</code>.</li>
</ul>
</li>
</ul>
<p>As you can see, both <code>ptr</code> values are the same, meaning that both variables are pointing to the same data in the Heap. Let&rsquo;s print them in hexadecimal to get the correct format to explore it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffdb08
</span></span><span style="display:flex;"><span>0x7fffffffdb08: 0x00005555555a5ad0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffdb20
</span></span><span style="display:flex;"><span>0x7fffffffdb20: 0x00005555555a5ad0
</span></span></code></pre></div><p>So, the <code>ptr</code> value is <code>0x00005555555a5ad0</code>! Now, take a look at the contents of that address in the Heap:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/12c     0x00005555555a5ad0
</span></span><span style="display:flex;"><span>0x5555555a5ad0:	<span style="color:#ae81ff">104</span> <span style="color:#e6db74">&#39;h&#39;</span>	<span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>	<span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>	<span style="color:#ae81ff">119</span> <span style="color:#e6db74">&#39;w&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5ad8:	<span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span>	<span style="color:#ae81ff">33</span> <span style="color:#e6db74">&#39;!&#39;</span>
</span></span></code></pre></div><p>The <code>hello world!</code> string is there!</p>
<h1 id="conclusion">Conclusion</h1>
<p>It can take some time to get used to working with ownership and move semantics, but, in my opinion, that is well invested time. Manually mananging memory (by allocating and freeing it) is not an easy task and <a href="https://en.wikipedia.org/wiki/Manual_memory_management#Manual_management_and_correctness">can create several bugs</a>. With Rust&rsquo;s approach, those bugs are caught at compile time, so they can never happen!</p>
<p>If you want to read more about this topic, check out the <a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html">Rust book</a>.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Rust ownership y move semantics</title>
      <link>https://nicoan.github.io/posts/move_semantics.es/</link>
      <pubDate>Tue, 18 Oct 2022 12:00:00 -0300</pubDate>
      <guid>https://nicoan.github.io/posts/move_semantics.es/</guid>
      <description>Ownership y move semantics son dos conceptos que hacen a Rust único. Para entender este tema, es mejor primero entender que son el Stack y el Heap en un nivel básico. ¡Escribí un post sobre eso!
Es un poco difícil acostumbrarse a estos mecanismos, porque fuerzan al programador a pensar en cosas en las que no se tiene que preocupar en otros lenguajes. ¡Suficiente introducción! vamos a ver de qué se trata todo esto.</description>
      <content:encoded><![CDATA[<p>Ownership y move semantics son dos conceptos que hacen a Rust único. Para entender este tema, es mejor primero entender que son el Stack y el Heap en un nivel básico. ¡Escribí un <a href="/es/posts/stack_and_heap">post</a> sobre eso!</p>
<p>Es un poco difícil acostumbrarse a estos mecanismos, porque fuerzan al programador a pensar en cosas en las que no se tiene que preocupar en otros lenguajes. ¡Suficiente introducción! vamos a ver de qué se trata todo esto.</p>
<h1 id="las-tres-reglas-de-ownership">Las tres reglas de ownership</h1>
<p>Existen tres reglas que gobiernan el sistema de ownership:</p>
<ol>
<li><strong>Todo valor inicializado tiene un dueño (owner)</strong>: Todo valor inicializado tiene una variable a la cual pertenece.¹</li>
<li><strong>Sólo hay <em>un</em> dueño por valor</strong>: No pueden existir dos o más variables que sean dueñas del <em>mismo</em> valor en memoria. No se puede compartir la posesión entre variables.²</li>
<li><strong>Si el scope de una variable termina, su valor se libera</strong>: Cuando un scope termina, todos los valores de las variables contenidas en ese scope se liberan automáticamente.</li>
</ol>
<p>¹ Pero no todas las variables son dueñas de un valor, éstas pueden contener sólo una referencia. Voy a hablar más en detalle de esto en el artículo &ldquo;Referencias y Borrowing&rdquo;. <br>
² En realidad se puede tener más de un dueño en Rust (sin usar <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html"><em>unsafe</em></a>). Se deben utilizar estructuras especiales como <a href="https://doc.rust-lang.org/stable/std/rc/struct.Rc.html">Rc</a> (de todas formas, los múltiples dueños no poseen el valor directamente).</p>
<p>¡Vamos a probar estas reglas! Pero antes de eso, un pequeño repaso de cómo se representa en memoria el tipo <code>String</code>:</p>
<p><img loading="lazy" src="/images/move_semantics/string_repr.png#center" alt="Representacion en memoria de String"  />
</p>
<p>donde:</p>
<ul>
<li><strong>ptr</strong>: Un puntero a la primera dirección del Heap donde esta alojado el texto (en este caso <code>hello</code>).</li>
<li><strong>len</strong>: Cuánta memoria, en bytes, el contenido del texto está utilizando en un momento dado.</li>
<li><strong>capacity</strong>: La cantidad total de memoria, en bytes, reservada para ese string.</li>
</ul>
<h3 id="gdb">GDB</h3>
<p>En este post voy a explorar qué está pasando en la memoria a través de <a href="https://en.wikipedia.org/wiki/GNU_Debugger">GNU Debugger (gdb)</a> con el comando especial <code>rust-gdb</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ rust-gdb ./target/debug/move_semantics
</span></span></code></pre></div><p>Dentro de GDB, voy a utilizar muchísimo el <a href="https://visualgdb.com/gdbreference/commands/x">comando x</a> y el valor <code>$sp</code> (Stack Pointer) para explorar el stack.</p>
<h2 id="regla-1-todo-valor-inicializado-tiene-un-dueño-owner">Regla 1: Todo valor inicializado tiene un dueño (owner).</h2>
<p>Dado el siguiente código:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">hello_world</span>() -&gt; <span style="color:#66d9ef">u32</span> {
</span></span><span style="display:flex;"><span>    String::from(<span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span>);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    hello_world();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>En la función <code>hello_world</code> tenemos un valor inicializado de tipo <code>String</code> que está libre(no asignado a ninguna variable). ¿Rust inicializó el valor en memoria o simplemente lo ignoró? No tenemos forma de usarlo, entonces&hellip; ¿Por qué Rust lo guardaría? ¡Vamos a ver qué sucede! Cuando compilamos este código vemos la siguiente advertencia:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>warning: unused <span style="color:#66d9ef">return</span> value of <span style="color:#e6db74">`</span>from<span style="color:#e6db74">`</span> that must be used
</span></span><span style="display:flex;"><span> --&gt; src/main.rs:2:5
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> |     String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">=</span> note: <span style="color:#e6db74">`</span><span style="color:#75715e">#[warn(unused_must_use)]` on by default</span>
</span></span></code></pre></div><p>Rust nos advierte que debemos utilizar el valor retornado de <code>String::from</code>, de otro modo, no lo podremos acceder de ninguna forma. ¿Qué pasa en la memoria? Vamos a verlo con GDB!</p>
<p>Primero ponemos un breakpoint al principio de la función <code>hello_world</code> y ejecutamos la inicialización del <code>String</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, move_semantics::hello_world <span style="color:#f92672">()</span> at src/main.rs:2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>           String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello! I am a free initialized String!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> n
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>           println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, 42<span style="color:#f92672">)</span>;
</span></span></code></pre></div><p>En este punto, el <code>String</code> fue inicializado pero no está asignado a ninguna variable. ¡No tiene dueño! Vamos a ver qué pasa en el Stack:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80ub $sp
</span></span><span style="display:flex;"><span>0x7fffffffd980: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">240</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd988: <span style="color:#ae81ff">61</span>      <span style="color:#ae81ff">60</span>      <span style="color:#ae81ff">87</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd990: <span style="color:#ae81ff">16</span>      <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">90</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">85</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd998: <span style="color:#ae81ff">38</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffd9a0: <span style="color:#ae81ff">38</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9a8: <span style="color:#ae81ff">2</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b0: <span style="color:#ae81ff">48</span>      <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9b8: <span style="color:#ae81ff">96</span>      <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9c0: <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">240</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">255</span>     <span style="color:#ae81ff">127</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffd9c8: <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Aparentemente el valor está ahí, parece ser que nuestro valor inicializado está desde la línea 4 a la 6: Las direcciones de memoria <code>0x7fffffffd998</code> y <code>0x7fffffffd9a0</code> (líneas 5 y 6) tienen guardado el valor 38 coincidiendo con el largo del String. ¡<code>0x7fffffffd990</code> (línea 4) debe ser la dirección del Heap donde está alojado el texto! Veamos qué hay dentro de esa dirección de memoria.</p>
<p>Primero, imprimimos dicha dirección en hexadecimal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd990
</span></span><span style="display:flex;"><span>0x7fffffffd990:	0x00005555555a5a10
</span></span></code></pre></div><p>Luego, exploramos qué hay dentro:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/38cb 0x00005555555a5a10
</span></span><span style="display:flex;"><span>0x5555555a5a10: <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a18: <span style="color:#ae81ff">16</span> <span style="color:#e6db74">&#39;\020&#39;</span>       <span style="color:#ae81ff">80</span> <span style="color:#e6db74">&#39;P&#39;</span>  <span style="color:#ae81ff">90</span> <span style="color:#e6db74">&#39;Z&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>  <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>        <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a20: <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">110</span> <span style="color:#e6db74">&#39;n&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">116</span> <span style="color:#e6db74">&#39;t&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a28: <span style="color:#ae81ff">97</span> <span style="color:#e6db74">&#39;a&#39;</span>  <span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">122</span> <span style="color:#e6db74">&#39;z&#39;</span> <span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span> <span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span> <span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>  <span style="color:#ae81ff">83</span> <span style="color:#e6db74">&#39;S&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5a30: <span style="color:#ae81ff">116</span> <span style="color:#e6db74">&#39;t&#39;</span> <span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span> <span style="color:#ae81ff">105</span> <span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#ae81ff">110</span> <span style="color:#e6db74">&#39;n&#39;</span> <span style="color:#ae81ff">103</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#ae81ff">33</span> <span style="color:#e6db74">&#39;!&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>¡El <code>String</code> está <strong>casi</strong> ahí! Parece que el principio fue sobreescrito. No hay problema, ninguna variable es dueña de ese valor, no lo podemos acceder de ninguna forma, por lo que no importa qué suceda con el mismo.</p>
<p><strong>NOTA</strong>: La memoria fue explorada utilizando un binario construido para <em>debug</em>. No estoy seguro de qué pasa si se compila en modo <em>release</em>. Dado que el valor no se usa, creo que Rust no lo inicializa, como una forma de optimización.</p>
<h2 id="regla-2-sólo-hay-un-dueño-por-valor">Regla 2: Sólo hay un dueño por valor</h2>
<p>Dado el siguiente código:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Creamos un nuevo valor, con s1 como dueño
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Movemos la posesión del valor a s2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Oops! error al compilar, el valor fue movido!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, s1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cuando lo intentamos obtenemos:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>error<span style="color:#f92672">[</span>E0382<span style="color:#f92672">]</span>: borrow of moved value: <span style="color:#e6db74">`</span>s1<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span> --&gt; src/main.rs:7:20
</span></span><span style="display:flex;"><span>  |
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> |     let s1 <span style="color:#f92672">=</span> String::from<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello world!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |         -- move occurs because <span style="color:#e6db74">`</span>s1<span style="color:#e6db74">`</span> has type <span style="color:#e6db74">`</span>String<span style="color:#e6db74">`</span>, which does not implement the <span style="color:#e6db74">`</span>Copy<span style="color:#e6db74">`</span> trait
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span> |     // Move ownership from s1 to s2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span> |     let s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>  |              -- value moved here
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> |     // Oops! compiler error, the value has been moved!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">7</span> |     println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, s1<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>  |                    ^^ value borrowed here after move
</span></span></code></pre></div><p>Lo que está sucediendo es que la posesión del <code>String</code> <code>&quot;hello world!&quot;</code> es transferida de <code>s1</code> a <code>s2</code>. Por ese motivo, el compilador invalida el acceso a <code>s1</code>.</p>
<p>El valor fue movido porque el tipo <code>String</code> no implementa el trait <a href="https://doc.rust-lang.org/std/marker/trait.Copy.html">Copy</a>. Este trait es utilizado en tipos que pueden ser completamente alojados en el Stack y pueden ser duplicados simplemente copiando sus bits sin mucha sobrecarga (duplicar datos en el Heap es bastante más complicado). Cuando un tipo implementa el trait <code>Copy</code>, en lugar comportarse con &ldquo;semántica de movimiento&rdquo; (move semantics) se comporta con &ldquo;semántica de copiado&rdquo; (copy semantics). Este suele ser el caso para los tipos primitivos:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n2 <span style="color:#f92672">=</span> n1;
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, n1);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, n1, n2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Si corremos este código&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo run
</span></span><span style="display:flex;"><span>   Compiling move_semantics v0.1.0 <span style="color:#f92672">(</span>/home/rust/blog<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Finished dev <span style="color:#f92672">[</span>unoptimized + debuginfo<span style="color:#f92672">]</span> target<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> in 0.30s
</span></span><span style="display:flex;"><span>     Running <span style="color:#e6db74">`</span>target/debug/move_semantics<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span>
</span></span></code></pre></div><p>¡Compila! Porque el valor <code>42</code> es copiado.</p>
<h2 id="regla-3-si-el-scope-de-una-variable-termina-su-valor-se-libera">Regla 3: Si el scope de una variable termina, su valor se libera</h2>
<p>Dado el siguiente código:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Creamos un nuevo valor con s1 como dueña
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e">// s1 se libera aca! por ser el final del scope
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Checking drop with gdb!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>La memoria que ocupaba <code>s1</code> ya va a haber sido liberada cuando la ejecución llegue a la línea 7. Esto es porque las llaves al principio de la función <code>main</code> crean un nuevo scope. Una vez que éste termina, todas las variables que contenía se liberan. Veámoslo en GDB:</p>
<p>En la línea 4, podemos encontrar a <code>s1</code> en las variables locales del scope:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Breakpoint 1, move_semantics::main <span style="color:#f92672">()</span> at src/main.rs:4
</span></span><span style="display:flex;"><span>4	        println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;{}&#34;</span>, s1<span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>s1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span></code></pre></div><p>Veamos ahora, en qué dirección del Heap se encuentra alojado <code>s1</code> y qué contiene (recuerden que el primer campo de un <code>String</code> de su representación en el Stack es el puntero al Heap):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s1
</span></span><span style="display:flex;"><span>$1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffd960
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffd960
</span></span><span style="display:flex;"><span>0x7fffffffd960:	0x00005555555a5ad0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/12c 0x00005555555a5ad0
</span></span><span style="display:flex;"><span>0x5555555a5ad0:	<span style="color:#ae81ff">104</span> <span style="color:#e6db74">&#39;h&#39;</span>	<span style="color:#ae81ff">101</span> <span style="color:#e6db74">&#39;e&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>	<span style="color:#ae81ff">32</span> <span style="color:#e6db74">&#39; &#39;</span>	<span style="color:#ae81ff">119</span> <span style="color:#e6db74">&#39;w&#39;</span>	<span style="color:#ae81ff">111</span> <span style="color:#e6db74">&#39;o&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5ad8:	<span style="color:#ae81ff">114</span> <span style="color:#e6db74">&#39;r&#39;</span>	<span style="color:#ae81ff">108</span> <span style="color:#e6db74">&#39;l&#39;</span>	<span style="color:#ae81ff">100</span> <span style="color:#e6db74">&#39;d&#39;</span>	<span style="color:#ae81ff">33</span> <span style="color:#e6db74">&#39;!&#39;</span>
</span></span></code></pre></div><p>Pero cuando el scope termina&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>7	    println!<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Checking drop with gdb!&#34;</span><span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>No locals.
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/12c 0x00005555555a5ad0
</span></span><span style="display:flex;"><span>0x5555555a5ad0:	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>	<span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>
</span></span><span style="display:flex;"><span>0x5555555a5ad8:	<span style="color:#ae81ff">16</span> <span style="color:#e6db74">&#39;\020&#39;</span>	<span style="color:#ae81ff">80</span> <span style="color:#e6db74">&#39;P&#39;</span>	<span style="color:#ae81ff">90</span> <span style="color:#e6db74">&#39;Z&#39;</span>	<span style="color:#ae81ff">85</span> <span style="color:#e6db74">&#39;U&#39;</span>
</span></span></code></pre></div><p>¡Todas las variables locales fueron liberadas! Es por ese motivo que esa parte del Heap está lleno con otra cosa (probablemente basura).</p>
<h1 id="moviendo-un-valor-qué-pasa-por-detrás">Moviendo un valor. ¿Qué pasa por detrás?</h1>
<p>Dado el siguiente código:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">move_stack_example</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Creamos un nuevo valor de tipo String
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s1 <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello world!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Lo movemos de s1 a s2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> s2 <span style="color:#f92672">=</span> s1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, s2);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    move_stack_example();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cuando movemos un valor, éste no desaparece de la memoria, sino que toda su representación <em>en el Stack</em> se duplica y el compilador nos prohíbe acceder a la vieja variable de nuevo.</p>
<p><img loading="lazy" src="/images/move_semantics/es/under_the_hood.png#center" alt="Detras de escena"  />
</p>
<p>Vamos a verificar lo que acabo de decir con GDB. Para esto, examinaremos el stack frame de la función <code>move_stack_example</code>. Antes que nada, veamos qué variables locales están definidas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info locals
</span></span><span style="display:flex;"><span>s2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span><span style="display:flex;"><span>s1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello world!&#34;</span>
</span></span></code></pre></div><p>¡Wow, parece que <code>s1</code> y <code>s2</code> contienen el mismo valor! En realidad están <strong>apuntando</strong> al mismo valor. Vamos a ver qué direcciones de memoria tomaron <code>s1</code> y <code>s2</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s1
</span></span><span style="display:flex;"><span>$1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffdb08
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p &amp;s2
</span></span><span style="display:flex;"><span>$2 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>*mut alloc::string::String<span style="color:#f92672">)</span> 0x7fffffffdb20
</span></span></code></pre></div><p>¡Fantástico! Ahora sabemos que la representación de <code>s1</code> en el stack empieza en la dirección <code>0x7fffffffdb08</code> y la representación de <code>s2</code> empieza en <code>0x7fffffffdb20</code>. Vamos ahora a ver el contenido del frame:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span></span><span style="background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/80bu $sp
</span></span><span style="display:flex;"><span>0x7fffffffdaf0:	112	171	217	247	255	127	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdaf8:	7	125	221	247	255	127	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdb00:	2	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb08:	208	90	90	85	85	85	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb10:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb18:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb20:	208	90	90	85	85	85	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb28:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>0x7fffffffdb30:	12	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0x7fffffffdb38:	0	0	0	0	0	0	0	<span style="color:#ae81ff">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>¿Qué tenemos en dichas direcciones? ¡La representación en memoria del tipo <code>String</code>! Veamos:</p>
<ul>
<li><strong>ptr</strong>:
<ul>
<li>Para <code>s1</code> este valor está en <code>0x7fffffffdb08</code>.</li>
<li>Para <code>s2</code> este valor está en <code>0x7fffffffdb20</code>.</li>
</ul>
</li>
<li><strong>len</strong>:
<ul>
<li>Para <code>s1</code> este valor está en <code>0x7fffffffdb10</code>.</li>
<li>Para <code>s2</code> este valor está en <code>0x7fffffffdb28</code>.</li>
</ul>
</li>
<li><strong>capacity</strong>:
<ul>
<li>Para <code>s1</code> este valor está en <code>0x7fffffffdb18</code>.</li>
<li>Para <code>s2</code> este valor está en <code>0x7fffffffdb30</code>.</li>
</ul>
</li>
</ul>
<p>Como pueden observar, ambos valores de <code>ptr</code> son iguales, lo cuál significa que las dos variables apuntan a los mismos datos en el Heap. Vamos a imprimir estos valores en hexadecimal para obtener el formato correcto para poder explorarlo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffdb08
</span></span><span style="display:flex;"><span>0x7fffffffdb08: 0x00005555555a5ad0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> x/xg 0x7fffffffdb20
</span></span><span style="display:flex;"><span>0x7fffffffdb20: 0x00005555555a5ad0
</span></span></code></pre></div><p>¡El valor de <code>ptr</code> es <code>0x00005555555a5ad0</code>! Ahora vamos a ver el contenido de dicha dirección del Heap:</p>
<pre tabindex="0"><code>(gdb) x/12c     0x00005555555a5ad0
0x5555555a5ad0:	104 &#39;h&#39;	101 &#39;e&#39;	108 &#39;l&#39;	108 &#39;l&#39;	111 &#39;o&#39;	32 &#39; &#39;	119 &#39;w&#39;	111 &#39;o&#39;
0x5555555a5ad8:	114 &#39;r&#39;	108 &#39;l&#39;	100 &#39;d&#39;	33 &#39;!&#39;
</code></pre><p>¡El texto <code>hello world!</code> está ahí!</p>
<h1 id="conclusión">Conclusión</h1>
<p>Puede tomar algo de tiempo acostumbrarse a <em>ownership</em> y <em>move semantics</em>, pero en mi opinión, es tiempo bien invertido. Manejar la memoria de forma manual no es una tarea fácil y puede llevat a tener <a href="https://en.wikipedia.org/wiki/Manual_memory_management#Manual_management_and_correctness">muchos bugs</a>. Con el enfoque de Rust, estos bugs son detectados en tiempo de compilación para que nunca puedan pasar.
Si querés leer más sobre este tema <a href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html">el libro de Rust</a> tiene un capítulo completamente dedicado.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Stack and Heap</title>
      <link>https://nicoan.github.io/posts/stack_and_heap/</link>
      <pubDate>Tue, 26 Jul 2022 12:00:00 -0300</pubDate>
      <guid>https://nicoan.github.io/posts/stack_and_heap/</guid>
      <description>Why write about Stack and Heap when there are already a lot of articles out there? I want to improve my writing skills so, I decided to write articles about things I find interesting. This article was supposed to be about how Rust manages memory through ownership. Then I thought &amp;ldquo;I should first write about Stack and Heap&amp;rdquo;. So, here we are).
To understand memory management first, we need to understand what the Stack and the Heap are.</description>
      <content:encoded><![CDATA[<p>Why write about Stack and Heap when there are already a lot of articles out there? I want to improve my writing skills so, I decided to write articles about things I find interesting. This article was supposed to be about how Rust manages memory through <a href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">ownership</a>. Then I thought &ldquo;I should first write about Stack and Heap&rdquo;. So, here we are).</p>
<p>To understand memory management first, we need to understand what the Stack and the Heap are. Stack and Heap are memory regions used by a process to store and read values. The memory of a running process can usually be divided in the following four regions:</p>
<p><img loading="lazy" src="/images/stack/memory.png#center" alt="Memory Regions"  />
</p>
<ul>
<li><strong>Text</strong>: Here is where our program instructions live. Our compiled program is loaded and stored in this region of the memory.</li>
<li><strong>Data</strong>: All the global variables are stored in this region.</li>
<li><strong>Stack</strong>: A contiguous chunk of memory that stores local variables, arguments and return addresses of functions (we will go deeper on this in the next section). Every process&rsquo; thread has its own Stack.</li>
<li><strong>Heap</strong>: Stores all the dynamically allocated memory. This region is shared among all threads of a process.</li>
</ul>
<h1 id="stack">Stack</h1>
<p>A process&rsquo; Stack is an actual implementation of the <a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)">Stack data structure</a>. It is fixed in size; we can not ask the operating system for more memory. This size depends mostly on the OS. In modern Linux systems, the <strong>maximum</strong> Stack size is 8 MB (you can check yours with the command <code>ulimit -s</code>).</p>
<h2 id="inside-the-stack">Inside the Stack</h2>
<p>Every time we call a function, a <em>Stack frame</em> (a chunk of contiguous memory containing all the information required by the recently called function) is created and placed on top of the Stack. And, every time a function ends, the Stack frame is popped from the Stack, automatically releasing all the memory used by it. Let&rsquo;s see a minimal example on how the Stack is populated. Consider the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">sum</span>(a: <span style="color:#66d9ef">i32</span>, b: <span style="color:#66d9ef">i32</span>) -&gt; <span style="color:#66d9ef">i32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>    result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">square_sum</span>(a: <span style="color:#66d9ef">i32</span>, b: <span style="color:#66d9ef">i32</span>) -&gt; <span style="color:#66d9ef">i32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> sum_result <span style="color:#f92672">=</span> sum(a, b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> pow_result <span style="color:#f92672">=</span> sum_result <span style="color:#f92672">*</span> sum_result;
</span></span><span style="display:flex;"><span>    pow_result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> pow_result <span style="color:#f92672">=</span> square_sum(n1, n2);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Result: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, pow_result);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The following diagram represents what happens with the Stack when the program is executed:</p>
<p><img loading="lazy" src="/images/stack/stack_1.png#center" alt="Executing Stack"  />
</p>
<ol>
<li>At the beginning, a Stack frame for the <code>main</code> function is created.</li>
<li><code>main</code> calls <code>square_sum</code>, a Stack frame for <code>square_sum</code> is created.</li>
<li><code>square_sum</code> calls <code>sum</code>, a Stack frame is created for <code>sum</code>.</li>
<li>After <code>sum</code> is called, its Stack frame is destroyed, releasing automatically all the memory it occupied.</li>
<li>After <code>square_sum</code> is called, its Stack frame is destroyed, releasing automatically all the memory it occupied.</li>
<li><code>main</code> prints the result and ends. The operating system frees up all the remaining memory.</li>
</ol>
<p><strong>NOTE</strong>: Usually, the stack grow downwards!</p>
<h2 id="inside-the-stack-frame">Inside the Stack frame</h2>
<p>The Stack frame is where all the local variables, arguments, and return address (this is used by the running process to know where the next code instruction to be executed is, after the function call ends) of a function live. The good news is that the user does not have to worry about allocating or de-allocating the memory used by it (neither with Heap allocations in safe Rust, but that is for another post). Given that the Stack is fixed in size, we can only store data that its size is known at compile time. For dynamic sized data (such as <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html">vectors</a>), Heap memory is used (only a pointer to that part of the Heap memory and <em>maybe</em> some metadata is saved into the Stack). Let&rsquo;s expand the above Stack diagrams to show the stack frame of each function:</p>
<p><img loading="lazy" src="/images/stack/stack_2.png#center" alt="Stack Frame"  />
</p>
<p>How do we use the memory contained in the frame? We have two pointers that helps us with that:</p>
<ul>
<li><strong>Stack Pointer (SP)</strong>: Always points at the top of the Stack. When a Stack frame is created the new SP&rsquo;s value is <code>SP + size_of(new_Stack_frame)</code>. It will change any time a value is pushed onto or popped off the stack. When an executing function returns, it goes back to its previous size.</li>
<li><strong>Base Pointer (BP)</strong>: Also known as <em>Frame Pointer (FP)</em>. Points to the base of the current Stack frame. When a Stack frame is created, the BP gets the value SP had before adding the size of the new Stack frame. The <em>BP</em> is used to access the arguments and local variables of a function by adding/substracting the offset of the variable we want to access. For example, if we want to access the argument <code>y</code>, we need to read the address <code>BP + 12</code> because, first, we have the <code>return address</code> that (let&rsquo;s assume) is 4 bytes long, and then the argument <code>x</code> that is a 32 bits integer (4 bytes).</li>
</ul>
<p>The layout presented here is just an example. Although, in reality, the frames contain the same information, how the data is organized depends on the <a href="https://en.wikipedia.org/wiki/Calling_convention">machine architecture</a> and the <a href="https://en.wikipedia.org/wiki/Application_binary_interface">application binary interface (ABI)</a>.</p>
<p><a href="https://stackoverflow.com/questions/3699283/what-is-stack-frame-in-assembly#answer-3700219">This StackOverflow answer</a> shows how the frame is constructed using x86 assembly.</p>
<h1 id="heap">Heap</h1>
<p>In this context, &ldquo;Heap&rdquo; has nothing to do with the Heap data structure, it is just a name for the free memory pool.</p>
<p>The Heap is not fixed in size. We can ask for more memory, as long as it is available in the system, and free it if the allocated values are not needed anymore. Unlike Stack, when we are working with the Heap we have to take care of the allocation and deallocation of memory (in Rust, <strong>most</strong> allocation/deallocation logic is hidden behind abstractions). When we use the Heap, we are dynamically allocating memory. This comes in very handy when we are dealing with data which size is unknown at compile time (i.e. user input). In opposition to the Stack, the memory allocations are not sequential.</p>
<p>When a process wants to allocate some chunk of memory of a given size, the operating system first has to search for a free piece of memory with the needed size. After finding it, the OS locks it up (only that particular process can access that portion of the system memory) and returns the starting address of the block. This process leads to <em>memory fragmentation</em> (the data allocated in the Heap is <strong>not</strong> contiguous).</p>
<p>When we use the Heap, we also store some data in the Stack (<em>at least</em> a pointer to the allocated data). Consider the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1: Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Box::new(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> my_string <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, my_string, n1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>NOTE</strong>: A <a href="https://doc.rust-lang.org/rust-by-example/std/box.html">Box</a> is a smart pointer to a heap allocated value.</p>
<p>The following diagram shows the allocations made in the Stack and the Heap:</p>
<p><img loading="lazy" src="/images/stack/heap.png#center" alt="Heap"  />
</p>
<p>Writing and reading the Heap is slower than writing and reading the Stack for several reasons:</p>
<ul>
<li>For memory allocation, a process has to make a system call and wait for the OS to complete the process described above.</li>
<li>Using the allocated memory (for writing or reading) involves at least one indirection (following the pointer allocated in the Stack).</li>
<li>Under the right conditions, a program can be optimized to store some parts of the Stack inside the processor&rsquo;s cache, making writing/reading operations blazingly fast.</li>
</ul>
<h1 id="summary">Summary</h1>
<table>
<thead>
<tr>
<th>Stack</th>
<th>Heap</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fixed in size</td>
<td>Can grow or shrink</td>
</tr>
<tr>
<td>Allocations are in a contiguous block</td>
<td>Allocation happens in &ldquo;random&rdquo; order</td>
</tr>
<tr>
<td>Faster access time</td>
<td>Slower access time</td>
</tr>
<tr>
<td>Is thread local by default: every thread of a process has its own Stack.</td>
<td>Can be used to share memory across threads</td>
</tr>
</tbody>
</table>
]]></content:encoded>
    </item>
    <item>
      <title>Stack y Heap</title>
      <link>https://nicoan.github.io/posts/stack_and_heap.es/</link>
      <pubDate>Tue, 26 Jul 2022 12:00:00 -0300</pubDate>
      <guid>https://nicoan.github.io/posts/stack_and_heap.es/</guid>
      <description>¿Por qué escribir sobre Stack y Heap cuando ya existen pila (pun intended) de artículos en internet? Quiero mejorar mi escritura, y para cumplir este objetivo, decidí escribir artículos sobre cosas que encuentro interesantes. La idea es mejorar mi escritura tanto en inglés (ver arriba a la derecha, hay un link a este mismo artículo en dicho idioma) como en español. Originalmente, este post iba a tratar sobre cómo Rust maneja la memoria a través de lo que se conoce como ownership, pero luego pensé &amp;ldquo;debería primero escribir sobre Stack y Heap&amp;rdquo;.</description>
      <content:encoded><![CDATA[<p>¿Por qué escribir sobre Stack y Heap cuando ya existen pila (<em>pun intended</em>) de artículos en internet? Quiero mejorar mi escritura, y para cumplir este objetivo, decidí escribir artículos sobre cosas que encuentro interesantes. La idea es mejorar mi escritura tanto en inglés (ver arriba a la derecha, hay un link a este mismo artículo en dicho idioma) como en español. Originalmente, este post iba a tratar sobre cómo Rust maneja la memoria a través de lo que se conoce como <a href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">ownership</a>, pero luego pensé &ldquo;debería primero escribir sobre Stack y Heap&rdquo;.</p>
<p>Para entender cómo administrar el uso de memoria, primero tenemos que entender qué son el Stack y el Heap. Stack y Heap son regiones de memoria utilizadas por procesos para guardar y leer valores. La memoria de un proceso normalmente se puede dividir en cuatro regiones:</p>
<p><img loading="lazy" src="/images/stack/memory.png#center" alt="Regiones de memoria"  />
</p>
<ul>
<li><strong>Text</strong>: Aquí viven las instrucciones del nuestro programa. El programa ya compilado se carga y guarda en esta región.</li>
<li><strong>Data</strong>: Todas las variables globales se guardan en esta región.</li>
<li><strong>Stack</strong>: Es un pedazo contíguo de memoria. En esta región se guardan las variables locales, argumentos y dirección de retorno de las funciones (vamos a ver esto más detalladamente en la próxima sección). Cada hilo de ejecución de un proceso tiene su propio Stack.</li>
<li><strong>Heap</strong>: Guarda todos los valores de memoria que fueron asignados dinámicamente. Esta región es compartida por todos los hilos de un proceso.</li>
</ul>
<h1 id="stack">Stack</h1>
<p>El Stack de un proceso es una implementación real de la <a href="https://es.wikipedia.org/wiki/Pila_(inform%C3%A1tica)">estructura de datos homónima</a>. Su tamaño es fijo; no podemos pedirle al sistema operativo más memoria. Este tamaño depende principalmente del SO. En sistemas Linux modernos, el tamaño <strong>máximo</strong> es de 8 MB (esto se puede verificar utilizando el comando <code>ulimit -s</code>)</p>
<h2 id="dentro-del-stack">Dentro del Stack</h2>
<p>Cada vez que llamamos a una función, un <em>Stack frame</em> (un pedazo de memoria contíguo que contiene toda la información requerida por la función recientemente llamada) es creado y puesto en la parte superior del Stack. Este proceso también sucede de forma inversa, es decir, cada vez que una función termina, el Stack frame es eliminado del Stack, liberando automáticamente toda la memoria utilizada por éste. A continuación veremos un ejemplo simple de cómo el Stack se va llenando. Consideremos el siguiente programa:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">sum</span>(a: <span style="color:#66d9ef">i32</span>, b: <span style="color:#66d9ef">i32</span>) -&gt; <span style="color:#66d9ef">i32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>    result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">square_sum</span>(a: <span style="color:#66d9ef">i32</span>, b: <span style="color:#66d9ef">i32</span>) -&gt; <span style="color:#66d9ef">i32</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> sum_result <span style="color:#f92672">=</span> sum(a, b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> pow_result <span style="color:#f92672">=</span> sum_result <span style="color:#f92672">*</span> sum_result;
</span></span><span style="display:flex;"><span>    pow_result
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> pow_result <span style="color:#f92672">=</span> square_sum(n1, n2);
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;Result: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, pow_result);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>El siguiente diagrama representa qué pasa con el Stack cuando el programa es ejecutado:</p>
<p><img loading="lazy" src="/images/stack/stack_1.png#center" alt="Stack en accion"  />
</p>
<ol>
<li>Al principio, un Stack frame para la función <code>main</code> es creado.</li>
<li><code>main</code> llama a <code>square_sum</code>, un Stack frame para <code>square_sum</code> es creado.</li>
<li><code>square_sum</code> llama a <code>sum</code>, un Stack frame es creado para <code>sum</code>.</li>
<li>Al terminar <code>sum</code>, su Stack frame es destruido, liberando automáticamente toda la memoria ocupada por esta función.</li>
<li>Al terminar <code>square_sum</code>, su Stack frame es destruido, liberando automáticamente toda la memoria ocupada por esta función.</li>
<li><code>main</code> imprime el resultado y el programa termina. El sistema operativo libera toda la memoria restante utilizada por el proceso que ejecutaba nuestro programa.</li>
</ol>
<p><strong>NOTA</strong>: Normalmente el stack crece hacia abajo!</p>
<h2 id="dentro-del-stack-frame">Dentro del Stack frame</h2>
<p>El Stack frame es donde todas las variables locales, argumentos y dirección de retorno (ésta es utilizada para saber cuál es la siguiente instrucción a ejecutar luego de que una llamada a función termina) de una función viven. Las buenas noticias son que el usuario no debe preocuparse por asignar o liberar la memoria utilizada por éste (si utilizamos safe Rust, tampoco lo debe hacer para asignaciones en el Heap, pero eso es para otro artículo). Dado que el Stack tiene un tamaño fijo, sólo podemos guardar datos cuyo tamaño es conocido en <a href="https://es.wikipedia.org/wiki/Tiempo_de_compilaci%C3%B3n">tiempo de compilación</a>. Para datos de tamaño variable (por ejemplo, <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html">vectores</a>), el Heap es utilizado (sólo un puntero a esa parte del Heap y <em>tal vez</em> algo de metadata es guardada en el Stack). A continuación vamos a expandir los diagramas presentados más arriba para mostrar el Stack frame de cada función:</p>
<p><img loading="lazy" src="/images/stack/es/stack_2.png#center" alt="Stack Frame"  />
</p>
<p>¿Cómo utilizamos la memoria contenida en un frame? Existen dos punteros que nos ayudan con eso:</p>
<ul>
<li><strong>Stack Pointer (SP)</strong>: Siempre apunta al tope del Stack. Cuando un Stack frame es creado, el nuevo valor de SP es <code>SP + size_of(new_Stack_frame)</code>. Este valor cambia cada vez que insertamos o quitamos un elemento. Cuando una función termina su ejecución, vuelve al valor que tenía antes de la llamada.</li>
<li><strong>Base Pointer (BP)</strong>: También conocido como <em>Frame Pointer (FP)</em>. Apunta a la base del último Stack frame. Cuando un Stack frame es creado, el <em>BP</em> es usado para acceder a los argumentos y variables locales de una función sumando/restando la posición de la variable que queremos acceder respecto al mismo <em>BP</em>. Por ejemplo, si queremos acceder al argumento <code>y</code>, necesitamos leer la dirección <code>BP + 12</code> porque, primero, tenemos la <code>dirección de retorno</code> que (asumimos) tiene un tamaño de 4 bytes, y luego, tenemos el argumento <code>x</code>, el cuál es un entero de 32 bits (4 bytes).</li>
</ul>
<p>La estructura presentada aquí es sólo un ejemplo. Aunque en la realidad los Stack frames contienen la misma información, cómo los datos son organizados dependen de la <a href="https://en.wikipedia.org/wiki/Calling_convention">arquitectura de la máquina</a> y de la <a href="https://es.wikipedia.org/wiki/Interfaz_binaria_de_aplicaciones">interfaz binaria de aplicación (ABI por sus siglas en inglés)</a>.</p>
<p><a href="https://stackoverflow.com/questions/3699283/what-is-stack-frame-in-assembly#answer-3700219">Esta respuesta de StackOverflow</a> muestra cómo el Stack frame es construido utilizando x86 assembly.</p>
<h1 id="heap">Heap</h1>
<p>En este contexto, &ldquo;Heap&rdquo; no tiene nada que ver con la estructura de datos Heap. Es sólo el nombre para la región de memoria &ldquo;libre&rdquo;.</p>
<p>El Heap no tiene un tamaño fijo. Podemos pedir más memoria, siempre y cuando esté disponible en el sistema, y liberarla si no necesitamos más los valores contenidos en ésta. A diferencia del Stack, cuando trabajamos con el Heap tenemos que admnistrar la asignación/liberación de memoria (en Rust, <strong>la mayoría</strong> de las asignaciones/liberaciones están escondidas detrás de abstracciones). Cuando utilizamos el Heap, estamos asignando memoria dinámicamente. Esto es muy conveniente cuando trabajamos con datos cuyo tamaño es desconocido en tiempo de compilación (como por ejemplo, texto ingresado por un usuario). Otra diferencia es que, las asignaciones de memoría <strong>no</strong> son secuenciales.</p>
<p>Cuando un proceso quiere asignar un pedazo de memoria de un tamaño determinado, el sistema operativo primero debe buscar una porción de memoria libre del volumen requerido. Luego de encontrarla, el SO bloquea dicha memoria (sólo el proceso que la pidió la puede acceder) y retorna la dirección correspondiente al primer bloque de ésta. Este proceso nos lleva al problema conocido como <em>fragmentación de memoria</em> (los datos guardados en el Heap <strong>no</strong> son contíguos).</p>
<p>Cuando utilizamos el Heap, también guardamos algunos datos en el Stack (<em>al menos</em> un puntero a los datos alojados en el Heap). Consideremos el siguiente código:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> n1: Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Box::new(<span style="color:#ae81ff">42</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> my_string <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;hello&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    println!(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, my_string, n1);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>NOTA</strong>: Un <a href="https://doc.rust-lang.org/rust-by-example/std/box.html">Box</a> es un <em><a href="https://es.wikipedia.org/wiki/Puntero_inteligente">puntero inteligente</a></em> hacia un valor alojado en el Heap.</p>
<p>El siguiente diagrama muestra las asignaciones hechas por el programa en el Stack y el Heap:</p>
<p><img loading="lazy" src="/images/stack/es/heap.png#center" alt="Heap"  />
</p>
<p>Escribir y leer el Heap es más lento que escribir y leer el Stack por varias razones:</p>
<ul>
<li>Para la asignación de memoria, un proceso tiene que hacer una llamada al sistema y esperar que el sistema operativo complete el proceso descripto más arriba.</li>
<li>Para utilizar la memoria (sea para escribir o leer), tenemos al menos un nivel de indirección (seguir el puntero alojado en el Stack).</li>
<li>Bajo las condiciones correctas, un programa puede ser optimizado para guardar algunas partes del Stack dentro de la caché del procesador, haciendo las lecturas/escrituras increíblemente rápidas.</li>
</ul>
<h1 id="resumen">Resumen</h1>
<table>
<thead>
<tr>
<th>Stack</th>
<th>Heap</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tamaño fijo</td>
<td>Tamaño variable</td>
</tr>
<tr>
<td>Las asignaciones son contiguas</td>
<td>Las asignaciones suceden en orden &ldquo;aleatorio&rdquo;</td>
</tr>
<tr>
<td>Tiempo de acceso rápido</td>
<td>Tiempo de acceso lento</td>
</tr>
<tr>
<td>Es &ldquo;thread local&rdquo; por definición</td>
<td>Puede ser utilizado para compartir memoria entre procesos</td>
</tr>
</tbody>
</table>
]]></content:encoded>
    </item>
  </channel>
</rss>
