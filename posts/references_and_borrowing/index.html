<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rust references and borrowing from the inside | Nico Antinori</title>
<meta name=keywords content><meta name=description content="Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.
GDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:"><meta name=author content="Nicolás Antinori"><link rel=canonical href=https://nicoan.github.io/posts/references_and_borrowing/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://nicoan.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nicoan.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://nicoan.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://nicoan.github.io/apple-touch-icon.png><link rel=mask-icon href=https://nicoan.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://nicoan.github.io/posts/references_and_borrowing/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Rust references and borrowing from the inside"><meta property="og:description" content="Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.
GDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:"><meta property="og:type" content="article"><meta property="og:url" content="https://nicoan.github.io/posts/references_and_borrowing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-24T12:00:00-03:00"><meta property="article:modified_time" content="2024-03-24T12:00:00-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust references and borrowing from the inside"><meta name=twitter:description content="Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.
GDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://nicoan.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Rust references and borrowing from the inside","item":"https://nicoan.github.io/posts/references_and_borrowing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rust references and borrowing from the inside","name":"Rust references and borrowing from the inside","description":"Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.\nGDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:","keywords":[],"articleBody":"Now it is time to talk about references and borrowing. To understand this topic, first check out this post where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.\nGDB In this post I am going to explore what is happening in memory using the GNU Debugger (gdb) with the special command rust-gdb:\nWhat is a reference in Rust? A reference is a value that points to data in memory. Although it is similar to a classic pointer there is a crucial difference between the two: a reference is guaranteed to always point to a memory address that contains a valid piece of data whereas pointers are not¹. The checks performed to guarantee that a reference is always valid is done at compile time.\nConsider the following code:\n1 2 3 4 5 6 7 8 9 fn main() { // Create a new value, with s1 as owner let s1 = String::from(\"hello world!\"); // Create a reference of s1 let s2 = \u0026s1; // Print the s2 value println!(\"{}\", s2); } This code compiles and runs correctly. What happens in memory? Let’s check it out with GDB!\nBreakpoint 1, references_and_borrowing::main () at src/main.rs:3 3 let s1 = String::from(\"hello world!\"); (gdb) n 5 let s2 = \u0026s1; (gdb) n 8 println!(\"{}\", s2); At this point, the String s1 is initialized with the text \"hello world! and the s1’s reference named s2 is set. Let’s check the stack:\n1 2 3 4 5 6 7 8 9 10 0x7fffffffd920: 56 217 255 255 255 127 0 0 0x7fffffffd928: 112 251 90 85 85 85 0 0 0x7fffffffd930: 32 208 255 247 255 127 0 0 0x7fffffffd938: 160 251 90 85 85 85 0 0 0x7fffffffd940: 12 0 0 0 0 0 0 0 0x7fffffffd948: 12 0 0 0 0 0 0 0 0x7fffffffd950: 56 217 255 255 255 127 0 0 0x7fffffffd958: 128 167 218 247 255 127 0 0 0x7fffffffd960: 0 0 0 0 0 0 0 0 0x7fffffffd968: 0 0 0 0 0 0 0 0 The lines 4 to 6 is the representation of s1 in the stack: 0x7fffffffd938 is ptr, 0x7fffffffd940 is len and 0x7fffffffd948 is capacity. The reference to s1 is located at 0x7fffffffd950. Let’s print the address value in hexadecimal:\n(gdb) x/xg 0x7fffffffd950 0x7fffffffd950: 0x00007fffffffd938 As we can see, the value contained in the address 0x7fffffffd950 is 0x00007fffffffd938², the beginning of the s1’s stack representation!\n¹ An invalid memory region refers to a region that was not assigned to our process or memory that was valid at some point of the program execution but then was freed. ² Zeroes are trimmed for legibility when printed as a memory address by GDB.\nThe two rules of references As everything in Rust, references have their own set of rules.\nReferences are always valid. At any given time we either have any number of immutable references or one mutable reference. References are always valid There’s no way of testing this rule at runtime (or at least I don’t know one). As I stated earlier in this post, references are guaranteed to always be valid and this validation is done at compile time.\nAt any given time we either have any number of immutable references or one mutable reference At first glance, this rule feels like an unnecessary limitation but thanks to it we are able to catch hidden bugs in our code because data races are avoided at compile time.\nA classic example is the one where we have n mutable references of the same piece of numeric data that represents a counter, all in different threads. The only thing the threads do is increment the counter. References by themselves do not have a synchronization mechanism. This is the concurrent counter problem, here’s the whole explanation and an example code in Java. This can’t happen in Rust (code won’t compile) since we need some kind of synchronization mechanism to mutate the same piece of data in different threads.\nThis is not the only problem this rule keeps us away from! In fact, we don’t even need concurrency, it can avoid bugs in simpler situations. Consider the following code in python:\n1 2 3 4 5 6 7 8 def insert_even_zeros(vec): for (n,i) in enumerate(vec): if n % 2 == 0: vec.insert(i, 0) vec = list(range(1,7)) # [1, 2, 3, 4, 5, 6] print(vec) What we are trying to do here is to insert a 0 at the index of a value, if the value is an even number. The expected result for the input [1, 2, 3, 4, 5, 6] is [1, 0, 2, 3, 0, 4, 5, 0, 6] but if we run it, we get [1, 0, 0, 0, 0, 0, 0, 2, 3, 4, 5, 6]. What is happening? The source of the problem resides in the fact that we are mutating the vector while iterating it:\nWe start at index 0 where the value 1 is located, since 1 is not even we continue to index 1. At index 1 we find value 2. It is even so we insert a 0 at index 1. Now the array is: [1, 0, 2, 3, 4, 5, 6]. We continue to index 2. At index 2 we find the value 2 again, because it was moved from its original position in the previous iteration. It is even so we insert a 0 at index 2. Now the array is: [1, 0, 0, 2, 3, 4, 5, 6]. This process is repeated 4 more times since the array length is 6 and how many iterations are going to be executed is calculated at the beginning of the for statement. This is known as the iterator invalidation problem.\nWhat happens in Rust?\n1 2 3 4 5 6 7 8 9 10 11 12 fn insert_even_zeros(vec: \u0026mut Vec\u003cu8\u003e) { for (i, n) in vec.iter().enumerate() { if n % 2 == 0 { vec.insert(i, 0); } } } fn main() { let mut v: Vec\u003cu8\u003e = (1..=6).collect(); // [1, 2, 3, 4, 5, 6] insert_even_zeros(\u0026mut v); } We get a compilation error that enforces the rule!\nerror[E0502]: cannot borrow `*vec` as mutable because it is also borrowed as immutable --\u003e src/main.rs:4:13 | 2 | for (i, n) in vec.iter().enumerate() { | ---------------------- | | | immutable borrow occurs here | immutable borrow later used here 3 | if n % 2 == 0 { 4 | vec.insert(i, 0); | ^^^^^^^^^^^^^^^^ mutable borrow occurs here For more information about this error, try `rustc --explain E0502`. Where are the mutable and immutable references? In the vector’s function signatures:\n.iter() takes an immutable reference of the vector (\u0026self): pub fn iter(\u0026self) -\u003e Iter\u003c'_, T\u003e .insert() takes a mutable reference of the vector (\u0026mut self): pub fn insert(\u0026mut self, index: usize, element: T) Does this mean that there’s no way of modifying a vector in Rust while iterating it? No! You can do it:\n1 2 3 4 5 6 7 8 9 10 11 12 fn main() { let mut v: Vec\u003cu8\u003e = (1..=6).collect(); let mut i: usize = 0; let v_len = v.len(); while i \u003c v_len { if v[i] % 2 == 0 { v.insert(i, 0); } i += 1 } } We also have two references, one immutable (len function) and one mutable (insert function). Why does it work? Because the scope of the immutable reference that is in len ends right after it the function is used (the scope of a reference begins at its creation and extends until the last time the reference is used).\nNotice that the error message we got with the for loop says “immutable borrow occurs here” and “immutable borrow later used here”. Both errors come from the same place, the iter() function, where the immutable reference is used.\nDoes it make sense for a programming language to have these kinds of rules if it is possible to write code to circumvent them? Yes! The way the last code is written is rather “unnatural”. Most of the time Rust will catch bugs at compile time thanks to these rules.\nBorrowing There are times when you don’t want a specific scope to lose ownership of a value. There could be several reasons for that, for example, you need to reuse the value. Consider the following code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 fn hello(s: String) { println!(\"hello {s}.\"); } fn bye(s: String) { println!(\"bye {s}.\"); } fn main() { let s = String::from(\"fellow blog reader\"); hello(s); bye(s); } This code won’t compile:\nerror[E0382]: use of moved value: `s` --\u003e src/main.rs:12:9 | 10 | let s = String::from(\"fellow blog reader\"); | - move occurs because `s` has type `String`, which does not implement the `Copy` trait 11 | hello(s); | - value moved here 12 | bye(s); | ^ value used here after move | note: consider changing this parameter type in function `hello` to borrow instead if owning the value isn't necessary --\u003e src/main.rs:1:13 | 1 | fn hello(s: String) { | ----- ^^^^^^ this parameter takes ownership of the value | | | in this function help: consider cloning the value if the performance cost is acceptable | 11 | hello(s.clone()); | ++++++++ Here we have a similar situation as we had here. As the compiler error says, we are moving s into hello, so when we try to use it in bye we get the “use after move” error. How can we solve this?\nSolution 1: Duplicating the value We can do as the compiler says, and clone the value. This way, both functions get a separate copy of the value that they can own:\n1 2 3 4 5 6 7 8 9 10 11 12 13 fn hello(s: String) { println!(\"hello {s}.\"); } fn bye(s: String) { println!(\"bye {s}.\"); } fn main() { let s = String::from(\"fellow blog reader\"); hello(s.clone()); bye(s); } This works! the code compiles and executes without a warning. Is this a good solution? No.\nWe don’t really need to duplicate s since we are only reading it to print it out. This solution does a lot of extra work by duplicating s’s value in memory.\nSolution 2: Returning the ownership back to the caller Instead of duplicating s’s value, we can return the ownership to the caller, so it can use it again:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 fn hello(s: String) -\u003e String { println!(\"hello {s}.\"); s } fn bye(s: String) { println!(\"bye {s}.\"); } fn main() { let s = String::from(\"fellow blog reader\"); let s2 = hello(s); bye(s2); } This also works! the code compiles and executes without a warning. Is this a good solution? Also no.\nPassing ownership back and forth functions is not a very comfortable and idiomatic way of doing things. On top of that, the function signatures are not semantically accurate. The signature of hello suggests that we pass an String value and returns back another String value. By just looking at it, it is hard to understand what the function intends to do and it does not make sense to return anything if the only objective of the function is only to print something.\nSolution 3: Borrowing We need to keep the ownership of s in the scope of the main function, we don’t want to duplicate values and we don’t want to move the values back and forth either. What can we do? use a reference!\n1 2 3 4 5 6 7 8 9 10 11 12 13 fn hello(s: \u0026String) { println!(\"hello {s}.\"); } fn bye(s: \u0026String) { println!(\"bye {s}.\"); } fn main() { let s = String::from(\"fellow blog reader\"); hello(\u0026s); bye(\u0026s); } The code compiles and executes without a warning. Is this a good solution? Yes.\nGiven that we only need to read the value, we don’t want to move it or duplicate it, using a reference is the best solution. Also, it is more idiomatic and semantically correct. By looking at the function’s signatures we know that they do not need to own any value and they will not return any result from the operation they are performing.\nLet’s now check what is happening in the memory with GDB:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Breakpoint 1, references_and_borrowing::main () at src/main.rs:10 10 let s = String::from(\"fellow blog reader\"); (gdb) n 11 hello(\u0026s); (gdb) x/80ub $sp 0x7fffffffd970: 2 0 0 0 0 0 0 0 0x7fffffffd978: 128 217 255 255 255 127 0 0 0x7fffffffd980: 160 251 90 85 85 85 0 0 0x7fffffffd988: 18 0 0 0 0 0 0 0 0x7fffffffd990: 18 0 0 0 0 0 0 0 0x7fffffffd998: 48 251 90 85 85 85 0 0 0x7fffffffd9a0: 1 0 0 0 0 0 0 0 0x7fffffffd9a8: 59 216 85 85 85 85 0 0 0x7fffffffd9b0: 0 240 127 255 255 127 0 0 0x7fffffffd9b8: 48 251 90 85 85 85 0 0 Looks like our String representation in the stack starts at 0x7fffffffd980. Let’s confirm it.\n(gdb) x/xg 0x7fffffffd980 0x7fffffffd980: 0x00005555555afba0 (gdb) x/18c 0x00005555555afba0 0x5555555afba0: 102 'f' 101 'e' 108 'l' 108 'l' 111 'o' 119 'w' 32 ' ' 98 'b' 0x5555555afba8: 108 'l' 111 'o' 103 'g' 32 ' ' 114 'r' 101 'e' 97 'a' 100 'd' 0x5555555afbb0: 101 'e' 114 'r' Excellent, now let’s continue with the program execution and check what’s in hello function’s stack:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Breakpoint 2, references_and_borrowing::hello (s=0x7fffffffd980) at src/main.rs:2 2 println!(\"hello {s}.\"); (gdb) x/80ub $sp 0x7fffffffd900: 128 217 255 255 255 127 0 0 0x7fffffffd908: 140 201 85 85 85 85 0 0 0x7fffffffd910: 32 208 255 247 255 127 0 0 0x7fffffffd918: 128 217 255 255 255 127 0 0 0x7fffffffd920: 128 217 255 255 255 127 0 0 0x7fffffffd928: 154 177 222 247 255 127 0 0 0x7fffffffd930: 160 251 90 85 85 85 0 0 0x7fffffffd938: 18 0 0 0 0 0 0 0 0x7fffffffd940: 18 0 0 0 0 0 0 0 0x7fffffffd948: 213 192 89 85 85 85 0 0 (gdb) x/xg 0x7fffffffd920 0x7fffffffd920: 0x00007fffffffd980 At 0x7fffffffd920 found a pointer pointing to s in main’s stack (0x7fffffffd920: 0x00007fffffffd980)! We can confirm that the whole representation still belongs to main’s scope and, in hello and bye functions, we are just referencing it. smemory will be freed once main finishes.\nThere’s no need to change the scope to borrow a value: the code used in the previous section, is just a slight modification of an example used in a previous post that did not compile. We fixed it by borrowing s1’s value to s2.\nConclusion Sometimes we have a hard time fighting the Rust compiler because it usually fails with errors that do not exist in other programming languages. Those errors feel arbitrary but, as we have seen in this post, they are there to protect us. It can take some time to wrap your head around them.\nThe more you code in Rust, the less you fight with the compiler and you end up with more performant and more secure programs. Also, a lot of errors are catched at compile time, saving us a lot of precious debugging time.\nThis post concludes a series of post about how Rust handles memory the internals of it:\nStack and Heap Rust ownership and move semantics from the inside Rust references and borrowing from the inside ","wordCount":"2620","inLanguage":"en","datePublished":"2024-03-24T12:00:00-03:00","dateModified":"2024-03-24T12:00:00-03:00","author":{"@type":"Person","name":"Nicolás Antinori"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nicoan.github.io/posts/references_and_borrowing/"},"publisher":{"@type":"Organization","name":"Nico Antinori","logo":{"@type":"ImageObject","url":"https://nicoan.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nicoan.github.io/ accesskey=h title="Nico Antinori (Alt + H)">Nico Antinori</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://nicoan.github.io/ title=Home><span>Home</span></a></li><li><a href=https://nicoan.github.io/blog/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Rust references and borrowing from the inside</h1><div class=post-meta><span title='2024-03-24 12:00:00 -0300 -03'>March 24, 2024</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Nicolás Antinori</div></header><div class=post-content><p>Now it is time to talk about references and borrowing. To understand this topic, first check out this <a href=/posts/move_semantics/>post</a> where I talk about ownership and move semantics. As we have seen in the named article, the way Rust manages memory allocations is rather unique. This is also true when we talk about referencing some place in the memory, something that can be achieved in C with pointers.</p><h3 id=gdb>GDB<a hidden class=anchor aria-hidden=true href=#gdb>#</a></h3><p>In this post I am going to explore what is happening in memory using the <a href=https://en.wikipedia.org/wiki/GNU_Debugger>GNU Debugger (gdb)</a> with the special command <code>rust-gdb</code>:</p><h1 id=what-is-a-reference-in-rust>What is a reference in Rust?<a hidden class=anchor aria-hidden=true href=#what-is-a-reference-in-rust>#</a></h1><p>A reference is a value that points to data in memory. Although it is similar to a classic pointer there is a crucial difference between the two: a reference is guaranteed to always point to a memory address that contains a valid piece of data whereas pointers are not¹. The checks performed to guarantee that a reference is always valid is done at <strong>compile time</strong>.</p><p>Consider the following code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a new value, with s1 as owner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> s1 <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;hello world!&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a reference of s1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> s2 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>s1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Print the s2 value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    println!(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, s2);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This code compiles and runs correctly. What happens in memory? Let’s check it out with GDB!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Breakpoint 1, references_and_borrowing::main <span style=color:#f92672>()</span> at src/main.rs:3
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>           let s1 <span style=color:#f92672>=</span> String::from<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello world!&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> n
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>           let s2 <span style=color:#f92672>=</span> &amp;s1;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> n
</span></span><span style=display:flex><span><span style=color:#ae81ff>8</span>           println!<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;{}&#34;</span>, s2<span style=color:#f92672>)</span>;
</span></span></code></pre></div><p>At this point, the <code>String</code> <code>s1</code> is initialized with the text <code>"hello world!</code> and the <code>s1</code>&rsquo;s reference named <code>s2</code> is set. Let&rsquo;s check the stack:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-bash data-lang=bash><span style=display:flex><span>0x7fffffffd920: <span style=color:#ae81ff>56</span>      <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd928: <span style=color:#ae81ff>112</span>     <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd930: <span style=color:#ae81ff>32</span>      <span style=color:#ae81ff>208</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>247</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd938: <span style=color:#ae81ff>160</span>     <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd940: <span style=color:#ae81ff>12</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd948: <span style=color:#ae81ff>12</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd950: <span style=color:#ae81ff>56</span>      <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd958: <span style=color:#ae81ff>128</span>     <span style=color:#ae81ff>167</span>     <span style=color:#ae81ff>218</span>     <span style=color:#ae81ff>247</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd960: <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd968: <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>The lines 4 to 6 is the representation of s1 in the stack: <code>0x7fffffffd938</code> is <strong><code>ptr</code></strong>, <code>0x7fffffffd940</code> is <strong><code>len</code></strong> and <code>0x7fffffffd948</code> is <strong><code>capacity</code></strong>. The reference to <code>s1</code> is located at <code>0x7fffffffd950</code>. Let&rsquo;s print the address value in hexadecimal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/xg 0x7fffffffd950
</span></span><span style=display:flex><span>0x7fffffffd950: 0x00007fffffffd938
</span></span></code></pre></div><p>As we can see, the value contained in the address <code>0x7fffffffd950</code> is <code>0x00007fffffffd938</code>², the beginning of the <code>s1</code>&rsquo;s stack representation!</p><p><img loading=lazy src=/images/references_and_borrowing/reference.png#center alt="Reference un memory"></p><p>¹ An invalid memory region refers to a region that was not assigned to our process or memory that was valid at some point of the program execution but then was freed.<br>² Zeroes are trimmed for legibility when printed as a memory address by GDB.</p><h2 id=the-two-rules-of-references>The two rules of references<a hidden class=anchor aria-hidden=true href=#the-two-rules-of-references>#</a></h2><p>As everything in Rust, references have their own set of rules.</p><ol><li>References are always valid.</li><li>At any given time we either have any number of immutable references or one mutable reference.</li></ol><h3 id=references-are-always-valid>References are always valid<a hidden class=anchor aria-hidden=true href=#references-are-always-valid>#</a></h3><p>There&rsquo;s no way of testing this rule at runtime (or at least I don&rsquo;t know one). As I stated earlier in this post, references are guaranteed to always be valid and this validation is done at compile time.</p><h3 id=at-any-given-time-we-either-have-any-number-of-immutable-references-or-one-mutable-reference>At any given time we either have any number of immutable references or one mutable reference<a hidden class=anchor aria-hidden=true href=#at-any-given-time-we-either-have-any-number-of-immutable-references-or-one-mutable-reference>#</a></h3><p>At first glance, this rule feels like an unnecessary limitation but thanks to it we are able to catch hidden bugs in our code because <a href=https://en.wikipedia.org/wiki/Race_condition#Data_race>data races</a> are avoided at compile time.</p><p>A classic example is the one where we have <code>n</code> mutable references of the same piece of numeric data that represents a counter, all in different threads. The only thing the threads do is increment the counter. References by themselves do not have a synchronization mechanism. This is the concurrent counter problem, <a href=https://knowledgebasement.com/what-are-concurrency-problems-and-how-to-avoid-them-in-java/>here&rsquo;s the whole explanation and an example code in Java</a>. This can&rsquo;t happen in Rust (code won&rsquo;t compile) since we need some kind of <a href=https://doc.rust-lang.org/std/sync/struct.Mutex.html>synchronization mechanism</a> to mutate the same piece of data in different threads.</p><p>This is not the only problem this rule keeps us away from! In fact, we don&rsquo;t even need concurrency, it can avoid bugs in simpler situations. Consider the following code in python:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>insert_even_zeros</span>(vec):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (n,i) <span style=color:#f92672>in</span> enumerate(vec):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            vec<span style=color:#f92672>.</span>insert(i, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vec <span style=color:#f92672>=</span> list(range(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>7</span>)) <span style=color:#75715e># [1, 2, 3, 4, 5, 6]</span>
</span></span><span style=display:flex><span>print(vec)
</span></span></code></pre></td></tr></table></div></div><p>What we are trying to do here is to insert a <code>0</code> at the index of a value, if the value is an even number. The expected result for the input <code>[1, 2, 3, 4, 5, 6]</code> is <code>[1, 0, 2, 3, 0, 4, 5, 0, 6]</code> but if we run it, we get <code>[1, 0, 0, 0, 0, 0, 0, 2, 3, 4, 5, 6]</code>. What is happening? The source of the problem resides in the fact that we are mutating the vector while iterating it:</p><ol><li>We start at index <code>0</code> where the value <code>1</code> is located, since <code>1</code> is not even we continue to index <code>1</code>.</li><li>At index <code>1</code> we find value <code>2</code>. It is even so we insert a <code>0</code> at index <code>1</code>. Now the array is: <code>[1, 0, 2, 3, 4, 5, 6]</code>. We continue to index <code>2</code>.</li><li>At index <code>2</code> we find the value <code>2</code> again, because it was moved from its original position in the previous iteration. It is even so we insert a <code>0</code> at index <code>2</code>. Now the array is: <code>[1, 0, 0, 2, 3, 4, 5, 6]</code>.</li><li>This process is repeated 4 more times since the array length is 6 and how many iterations are going to be executed is calculated at the beginning of the <code>for</code> statement.</li></ol><p>This is known as the <em>iterator invalidation</em> problem.</p><p>What happens in Rust?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>insert_even_zeros</span>(vec: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (i, n) <span style=color:#66d9ef>in</span> vec.iter().enumerate() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            vec.insert(i, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> v: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>..=</span><span style=color:#ae81ff>6</span>).collect(); <span style=color:#75715e>// [1, 2, 3, 4, 5, 6]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    insert_even_zeros(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> v);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>We get a compilation error that enforces the rule!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-bash data-lang=bash><span style=display:flex><span>error<span style=color:#f92672>[</span>E0502<span style=color:#f92672>]</span>: cannot borrow <span style=color:#e6db74>`</span>*vec<span style=color:#e6db74>`</span> as mutable because it is also borrowed as immutable
</span></span><span style=display:flex><span> --&gt; src/main.rs:4:13
</span></span><span style=display:flex><span>  |
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> |     <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i, n<span style=color:#f92672>)</span> in vec.iter<span style=color:#f92672>()</span>.enumerate<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  |                   ----------------------
</span></span><span style=display:flex><span>  |                   |
</span></span><span style=display:flex;background-color:#3c3d38><span>  |                   immutable borrow occurs here
</span></span><span style=display:flex;background-color:#3c3d38><span>  |                   immutable borrow later used here
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> |         <span style=color:#66d9ef>if</span> n % 2 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span> |             vec.insert<span style=color:#f92672>(</span>i, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span>  |             ^^^^^^^^^^^^^^^^ mutable borrow occurs here
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For more information about this error, try <span style=color:#e6db74>`</span>rustc --explain E0502<span style=color:#e6db74>`</span>.
</span></span></code></pre></div><p>Where are the mutable and immutable references? In the vector&rsquo;s function signatures:</p><ul><li><a href=https://doc.rust-lang.org/std/vec/struct.Vec.html#method.iter><code>.iter()</code></a> takes an immutable reference of the vector (<code>&amp;self</code>):</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>iter</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>Iter</span><span style=color:#f92672>&lt;</span>&#39;_, T<span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><ul><li><a href=https://doc.rust-lang.org/std/vec/struct.Vec.html#method.insert><code>.insert()</code></a> takes a mutable reference of the vector (<code>&amp;mut self</code>):</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>insert</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, index: <span style=color:#66d9ef>usize</span>, element: <span style=color:#a6e22e>T</span>)
</span></span></code></pre></div><p>Does this mean that there&rsquo;s no way of modifying a vector in Rust while iterating it? No! You can do it:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> v: Vec<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u8</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>..=</span><span style=color:#ae81ff>6</span>).collect();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> i: <span style=color:#66d9ef>usize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>let</span> v_len <span style=color:#f92672>=</span> v.len();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> i <span style=color:#f92672>&lt;</span> v_len {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> v[i] <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>            v.insert(i, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>We also have two references, one immutable (<code>len</code> function) and one mutable (<code>insert</code> function). Why does it work? Because the scope of the immutable reference that is in <code>len</code> ends right after it the function is used (the scope of a reference begins at its creation and extends until the last time the reference is used).</p><p>Notice that the error message we got with the <code>for</code> loop says &ldquo;<code>immutable borrow occurs here</code>&rdquo; and &ldquo;<code>immutable borrow later used here</code>&rdquo;. Both errors come from the same place, the <code>iter()</code> function, where the immutable reference is used.</p><p>Does it make sense for a programming language to have these kinds of rules if it is possible to write code to circumvent them? Yes! The way the last code is written is rather &ldquo;unnatural&rdquo;. Most of the time Rust will catch bugs at compile time thanks to these rules.</p><h1 id=borrowing>Borrowing<a hidden class=anchor aria-hidden=true href=#borrowing>#</a></h1><p>There are times when you don&rsquo;t want a specific scope to lose ownership of a value. There could be several reasons for that, for example, you need to reuse the value. Consider the following code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>hello</span>(s: String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;hello </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>bye</span>(s: String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;bye </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;fellow blog reader&#34;</span>);
</span></span><span style=display:flex><span>    hello(s);
</span></span><span style=display:flex><span>    bye(s);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This code won&rsquo;t compile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>error<span style=color:#f92672>[</span>E0382<span style=color:#f92672>]</span>: use of moved value: <span style=color:#e6db74>`</span>s<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>  --&gt; src/main.rs:12:9
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span> |     let s <span style=color:#f92672>=</span> String::from<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;fellow blog reader&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>   |         - move occurs because <span style=color:#e6db74>`</span>s<span style=color:#e6db74>`</span> has type <span style=color:#e6db74>`</span>String<span style=color:#e6db74>`</span>, which does not implement the <span style=color:#e6db74>`</span>Copy<span style=color:#e6db74>`</span> trait
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span> |     hello<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>   |           - value moved here
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span> |     bye<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>   |         ^ value used here after move
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span>note: consider changing this parameter type in <span style=color:#66d9ef>function</span> <span style=color:#e6db74>`</span>hello<span style=color:#e6db74>`</span> to borrow instead <span style=color:#66d9ef>if</span> owning the value isn<span style=color:#960050;background-color:#1e0010>&#39;</span>t necessary
</span></span><span style=display:flex><span>  --&gt; src/main.rs:1:13
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>  | fn hello<span style=color:#f92672>(</span>s: String<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   |    -----    ^^^^^^ this parameter takes ownership of the value
</span></span><span style=display:flex><span>   |    |
</span></span><span style=display:flex><span>   |    in this <span style=color:#66d9ef>function</span>
</span></span><span style=display:flex><span>help: consider cloning the value <span style=color:#66d9ef>if</span> the performance cost is acceptable
</span></span><span style=display:flex><span>   |
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span> |     hello<span style=color:#f92672>(</span>s.clone<span style=color:#f92672>())</span>;
</span></span><span style=display:flex><span>   |            ++++++++
</span></span></code></pre></div><p>Here we have a similar situation as we had <a href=/posts/move_semantics/#rule-2-theres-only-one-owner-per-value>here</a>. As the compiler error says, we are moving <code>s</code> into <code>hello</code>, so when we try to use it in <code>bye</code> we get the <a href=https://doc.rust-lang.org/error_codes/E0382.html>&ldquo;use after move&rdquo;</a> error. How can we solve this?</p><h3 id=solution-1-duplicating-the-value>Solution 1: Duplicating the value<a hidden class=anchor aria-hidden=true href=#solution-1-duplicating-the-value>#</a></h3><p>We can do as the compiler says, and <a href=https://doc.rust-lang.org/std/clone/trait.Clone.html>clone</a> the value. This way, both functions get a separate copy of the value that they can own:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>hello</span>(s: String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;hello </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>bye</span>(s: String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;bye </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;fellow blog reader&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    hello(s.clone());
</span></span><span style=display:flex><span>    bye(s);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This works! the code compiles and executes without a warning. Is this a good solution? No.</p><p>We don&rsquo;t really need to duplicate <code>s</code> since we are only reading it to print it out. This solution does a lot of extra work by duplicating <code>s</code>&rsquo;s value in memory.</p><h3 id=solution-2-returning-the-ownership-back-to-the-caller>Solution 2: Returning the ownership back to the caller<a hidden class=anchor aria-hidden=true href=#solution-2-returning-the-ownership-back-to-the-caller>#</a></h3><p>Instead of duplicating <code>s</code>&rsquo;s value, we can return the ownership to the caller, so it can use it again:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-rust data-lang=rust><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>hello</span>(s: String) -&gt; String {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;hello </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    s
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>bye</span>(s: String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;bye </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;fellow blog reader&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>let</span> s2 <span style=color:#f92672>=</span> hello(s);
</span></span><span style=display:flex;background-color:#3c3d38><span>    bye(s2);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This also works! the code compiles and executes without a warning. Is this a good solution? Also no.</p><p>Passing ownership back and forth functions is not a very comfortable and idiomatic way of doing things. On top of that, the function signatures are not semantically accurate. The signature of <code>hello</code> suggests that we pass an <code>String</code> value and returns back another <code>String</code> value. By just looking at it, it is hard to understand what the function intends to do and it does not make sense to return anything if the only objective of the function is only to print something.</p><h3 id=solution-3-borrowing>Solution 3: Borrowing<a hidden class=anchor aria-hidden=true href=#solution-3-borrowing>#</a></h3><p>We need to keep the ownership of <code>s</code> in the scope of the <code>main</code> function, we don&rsquo;t want to duplicate values and we don&rsquo;t want to move the values back and forth either. What can we do? use <a href=/posts/references_and_borrowing/#what-is-a-reference-in-rust>a reference</a>!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>hello</span>(s: <span style=color:#66d9ef>&amp;</span>String) {
</span></span><span style=display:flex;background-color:#3c3d38><span>    println!(<span style=color:#e6db74>&#34;hello </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>bye</span>(s: <span style=color:#66d9ef>&amp;</span>String) {
</span></span><span style=display:flex><span>    println!(<span style=color:#e6db74>&#34;bye </span><span style=color:#e6db74>{s}</span><span style=color:#e6db74>.&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> s <span style=color:#f92672>=</span> String::from(<span style=color:#e6db74>&#34;fellow blog reader&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    hello(<span style=color:#f92672>&amp;</span>s);
</span></span><span style=display:flex;background-color:#3c3d38><span>    bye(<span style=color:#f92672>&amp;</span>s);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The code compiles and executes without a warning. Is this a good solution? Yes.</p><p>Given that we only need to read the value, we don&rsquo;t want to move it or duplicate it, using a reference is the best solution. Also, it is more idiomatic and semantically correct. By looking at the function&rsquo;s signatures we know that they do not need to own any value and they will not return any result from the operation they are performing.</p><p>Let&rsquo;s now check what is happening in the memory with GDB:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-bash data-lang=bash><span style=display:flex><span>Breakpoint 1, references_and_borrowing::main <span style=color:#f92672>()</span> at src/main.rs:10
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>          let s <span style=color:#f92672>=</span> String::from<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;fellow blog reader&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> n
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span>          hello<span style=color:#f92672>(</span>&amp;s<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/80ub $sp
</span></span><span style=display:flex><span>0x7fffffffd970: <span style=color:#ae81ff>2</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd978: <span style=color:#ae81ff>128</span>     <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd980: <span style=color:#ae81ff>160</span>     <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd988: <span style=color:#ae81ff>18</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd990: <span style=color:#ae81ff>18</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd998: <span style=color:#ae81ff>48</span>      <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd9a0: <span style=color:#ae81ff>1</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd9a8: <span style=color:#ae81ff>59</span>      <span style=color:#ae81ff>216</span>     <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd9b0: <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>240</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd9b8: <span style=color:#ae81ff>48</span>      <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>Looks like our <code>String</code> representation in the stack starts at <code>0x7fffffffd980</code>. Let&rsquo;s confirm it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/xg 0x7fffffffd980
</span></span><span style=display:flex><span>0x7fffffffd980: 0x00005555555afba0
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/18c 0x00005555555afba0
</span></span><span style=display:flex><span>0x5555555afba0: <span style=color:#ae81ff>102</span> <span style=color:#e6db74>&#39;f&#39;</span> <span style=color:#ae81ff>101</span> <span style=color:#e6db74>&#39;e&#39;</span> <span style=color:#ae81ff>108</span> <span style=color:#e6db74>&#39;l&#39;</span> <span style=color:#ae81ff>108</span> <span style=color:#e6db74>&#39;l&#39;</span> <span style=color:#ae81ff>111</span> <span style=color:#e6db74>&#39;o&#39;</span> <span style=color:#ae81ff>119</span> <span style=color:#e6db74>&#39;w&#39;</span> <span style=color:#ae81ff>32</span> <span style=color:#e6db74>&#39; &#39;</span>  <span style=color:#ae81ff>98</span> <span style=color:#e6db74>&#39;b&#39;</span>
</span></span><span style=display:flex><span>0x5555555afba8: <span style=color:#ae81ff>108</span> <span style=color:#e6db74>&#39;l&#39;</span> <span style=color:#ae81ff>111</span> <span style=color:#e6db74>&#39;o&#39;</span> <span style=color:#ae81ff>103</span> <span style=color:#e6db74>&#39;g&#39;</span> <span style=color:#ae81ff>32</span> <span style=color:#e6db74>&#39; &#39;</span>  <span style=color:#ae81ff>114</span> <span style=color:#e6db74>&#39;r&#39;</span> <span style=color:#ae81ff>101</span> <span style=color:#e6db74>&#39;e&#39;</span> <span style=color:#ae81ff>97</span> <span style=color:#e6db74>&#39;a&#39;</span>  <span style=color:#ae81ff>100</span> <span style=color:#e6db74>&#39;d&#39;</span>
</span></span><span style=display:flex><span>0x5555555afbb0: <span style=color:#ae81ff>101</span> <span style=color:#e6db74>&#39;e&#39;</span> <span style=color:#ae81ff>114</span> <span style=color:#e6db74>&#39;r&#39;</span>
</span></span></code></pre></div><p>Excellent, now let&rsquo;s continue with the program execution and check what&rsquo;s in <code>hello</code> function&rsquo;s stack:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style=background-color:#3c3d38><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-bash data-lang=bash><span style=display:flex><span>Breakpoint 2, references_and_borrowing::hello <span style=color:#f92672>(</span>s<span style=color:#f92672>=</span>0x7fffffffd980<span style=color:#f92672>)</span> at src/main.rs:2
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>           println!<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello {s}.&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/80ub $sp
</span></span><span style=display:flex><span>0x7fffffffd900: <span style=color:#ae81ff>128</span>     <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd908: <span style=color:#ae81ff>140</span>     <span style=color:#ae81ff>201</span>     <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd910: <span style=color:#ae81ff>32</span>      <span style=color:#ae81ff>208</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>247</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd918: <span style=color:#ae81ff>128</span>     <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>0x7fffffffd920: <span style=color:#ae81ff>128</span>     <span style=color:#ae81ff>217</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd928: <span style=color:#ae81ff>154</span>     <span style=color:#ae81ff>177</span>     <span style=color:#ae81ff>222</span>     <span style=color:#ae81ff>247</span>     <span style=color:#ae81ff>255</span>     <span style=color:#ae81ff>127</span>     <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd930: <span style=color:#ae81ff>160</span>     <span style=color:#ae81ff>251</span>     <span style=color:#ae81ff>90</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd938: <span style=color:#ae81ff>18</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd940: <span style=color:#ae81ff>18</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>0x7fffffffd948: <span style=color:#ae81ff>213</span>     <span style=color:#ae81ff>192</span>     <span style=color:#ae81ff>89</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>85</span>      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> x/xg 0x7fffffffd920
</span></span><span style=display:flex><span>0x7fffffffd920: 0x00007fffffffd980
</span></span></code></pre></td></tr></table></div></div><p>At <code>0x7fffffffd920</code> found a pointer pointing to <code>s</code> in <code>main</code>&rsquo;s stack (<code>0x7fffffffd920: 0x00007fffffffd980</code>)! We can confirm that the whole representation still belongs to <code>main</code>&rsquo;s scope and, in <code>hello</code> and <code>bye</code> functions, we are just referencing it. <code>s</code>memory will be freed once <code>main</code> finishes.</p><p><img loading=lazy src=/images/references_and_borrowing/s_string.png#center alt="Borrowing in memory"></p><p>There&rsquo;s no need to change the scope to borrow a value: the <a href=/posts/references_and_borrowing/#what-is-a-reference-in-rust>code used in the previous section</a>, is just a slight modification of an <a href=/posts/move_semantics/#rule-2-theres-only-one-owner-per-value>example used in a previous post</a> that did not compile. We fixed it by borrowing <code>s1</code>&rsquo;s value to <code>s2</code>.</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><p>Sometimes we have a hard time fighting the Rust compiler because it usually fails with errors that do not exist in other programming languages. Those errors feel arbitrary but, as we have seen in this post, they are there to protect us. It can take some time to wrap your head around them.</p><p>The more you code in Rust, the less you fight with the compiler and you end up with more performant and more secure programs. Also, a lot of errors are catched at compile time, saving us a lot of precious debugging time.</p><p>This post concludes a series of post about how Rust handles memory the internals of it:</p><ol><li><a href=/posts/stack_and_heap/>Stack and Heap</a></li><li><a href=/posts/move_semantics/>Rust ownership and move semantics from the inside</a></li><li><a href=/posts/references_and_borrowing/>Rust references and borrowing from the inside</a></li></ol></div><footer class=post-footer><ul class=post-tags></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on x" href="https://x.com/intent/tweet/?text=Rust%20references%20and%20borrowing%20from%20the%20inside&amp;url=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f&amp;title=Rust%20references%20and%20borrowing%20from%20the%20inside&amp;summary=Rust%20references%20and%20borrowing%20from%20the%20inside&amp;source=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f&title=Rust%20references%20and%20borrowing%20from%20the%20inside"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on whatsapp" href="https://api.whatsapp.com/send?text=Rust%20references%20and%20borrowing%20from%20the%20inside%20-%20https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on telegram" href="https://telegram.me/share/url?text=Rust%20references%20and%20borrowing%20from%20the%20inside&amp;url=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Rust references and borrowing from the inside on ycombinator" href="https://news.ycombinator.com/submitlink?t=Rust%20references%20and%20borrowing%20from%20the%20inside&u=https%3a%2f%2fnicoan.github.io%2fposts%2freferences_and_borrowing%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://nicoan.github.io/>Nico Antinori</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>